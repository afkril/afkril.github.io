<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Control Tabla Valores</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg-body: #0a0a0c;
            --bg-card: rgba(30, 30, 35, 0.95);
            --primary-gold: #d4af37;
            --accent-cyan: #00f2ff;
            --text-main: #e2e8f0;
            --text-dim: #94a3b8;
            --danger: #ff4655;
            --success: #00ff88;
            --border-color: rgba(212, 175, 55, 0.3);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            background-image: radial-gradient(circle at 50% 0%, #1a1a2e 0%, #0a0a0c 100%);
            margin: 0; padding: 0; color: var(--text-main); font-size: 11px; min-height: 100vh;
        }

        /* --- Auth --- */
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .auth-box { background: var(--bg-card); padding: 40px; border-radius: 20px; border: 1px solid var(--primary-gold); width: 320px; text-align: center; }
        
        /* --- App --- */
        #app-content { display: none; padding: 20px; }
        .top-bar { background: var(--bg-card); padding: 15px 25px; border-radius: 12px; border: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }

        /* --- Drawers --- */
        .drawer { position: fixed; top: 0; width: 340px; height: 100%; background: var(--bg-card); z-index: 2000; transition: 0.4s; padding: 20px; overflow-y: auto; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        #drawer-archivo { left: -360px; border-right: 1px solid var(--primary-gold); }
        #drawer-archivo.open { left: 0; }
        #drawer-resumen { right: -360px; border-left: 1px solid var(--accent-cyan); }
        #drawer-resumen.open { right: 0; }

        .drawer-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); display: none; z-index: 1999; }
        
        #modal-ajustes { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 3000; align-items: center; justify-content: center; }
        .ajustes-container { background:#151518; width:450px; max-height: 80vh; overflow-y: auto; padding:25px; border-radius:15px; border:1px solid var(--primary-gold); }

        /* --- UI Elements --- */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(480px, 1fr)); gap: 20px; }
        .semana-card { background: var(--bg-card); padding: 10px 15px; border-radius: 12px; border: 1px solid var(--border-color); }
        table { width: 100%; border-collapse: separate; border-spacing: 0 4px; font-size: 10px; }
        td, th { padding: 2px 4px; background: rgba(255,255,255,0.02); border-radius: 4px; text-align: left; }
        input, select { background: rgba(0,0,0,0.4); border: 1px solid #444; color: white; padding: 4px 6px; border-radius: 4px; width: 100%; box-sizing: border-box; font-size: 11px; }
        .price-display { color: var(--primary-gold); font-family: monospace; font-weight: bold; text-align: right; border: none; background: transparent; }

        .btn { padding: 8px 12px; border-radius: 6px; font-weight: 800; cursor: pointer; border: 1px solid transparent; text-transform: uppercase; font-size: 10px; transition: 0.3s; }
        .btn-gold { background: var(--primary-gold); color: black; }
        .btn-cyan { background: var(--accent-cyan); color: black; }
        .btn-danger { background: var(--danger); color: white; border: none; }

        @media print {
            body * { visibility: hidden; }
            #summary-content, #summary-content * { visibility: visible; }
            #summary-content { position: absolute; left: 0; top: 0; width: 100%; color: black; background: white; padding: 20px; }
        }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box" id="login-form">
            <h1 style="color:var(--primary-gold)">LOGIN</h1>
            <input type="text" id="user-login" placeholder="Usuario" style="margin-bottom: 10px;">
            <input type="password" id="pass-login" placeholder="Contrase√±a" style="margin-bottom: 20px;">
            <button class="btn btn-gold" style="width:100%" onclick="handleAuth('login')">ENTRAR</button>
            <div style="margin-top:15px; cursor:pointer; font-size:1.3em; color:var(--accent-cyan)" onclick="toggleAuth(true)">Registrar nueva cuenta</div>
        </div>
        <div class="auth-box" id="reg-form" style="display:none">
            <h1 style="color:var(--accent-cyan)">REGISTRO</h1>
            <input type="text" id="user-reg" placeholder="Nuevo Usuario" style="margin-bottom: 10px;">
            <input type="password" id="pass-reg" placeholder="Contrase√±a" style="margin-bottom: 20px;">
            <button class="btn btn-cyan" style="width:100%" onclick="handleAuth('register')">CREAR CUENTA</button>
            <div style="margin-top:15px; cursor:pointer; font-size:1.3em; color:var(--primary-gold)" onclick="toggleAuth(false)">Volver al Login</div>
        </div>
    </div>

    <div id="app-content">
        <div class="drawer-overlay" id="overlay" onclick="closeAllDrawers()"></div>
        
        <div class="drawer" id="drawer-archivo">
            <h3 style="color: var(--primary-gold)">üìÇ ARCHIVOS GUARDADOS</h3>
            <div id="lista-guardados"></div>
        </div>

        <div class="drawer" id="drawer-resumen">
            <h3 style="color: var(--accent-cyan)">üìä BALANCE MENSUAL</h3>
            <div id="summary-content"></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                <button class="btn btn-cyan" onclick="exportExcel()">üì• EXCEL</button>
                <button class="btn btn-gold" onclick="window.print()">üñ®Ô∏è PDF</button>
            </div>
        </div>

        <header class="top-bar">
            <div style="display:flex; gap:10px;">
                <button class="btn" style="border:1px solid var(--primary-gold); color:var(--primary-gold)" onclick="toggleDrawer('archivo', true)">üìÇ ARCHIVO</button>
                <button class="btn btn-cyan" onclick="toggleDrawer('resumen', true)">üìä RESUMEN</button>
                <button class="btn" style="background:#222; color:var(--primary-gold); border:1px solid #444" onclick="toggleAjustes(true)">‚öôÔ∏è AJUSTES</button>
            </div>
            <div style="display:flex; gap:8px; align-items:center">
                <select id="main-mes" onchange="autoGuardado()" style="width:100px"><option>Enero</option><option>Febrero</option><option>Marzo</option><option>Abril</option><option>Mayo</option><option>Junio</option><option>Julio</option><option>Agosto</option><option>Septiembre</option><option>Octubre</option><option>Noviembre</option><option>Diciembre</option></select>
                
                <div style="display:flex; align-items:center; gap:5px; background:rgba(255,255,255,0.05); padding:2px 8px; border-radius:5px">
                    <small style="color:var(--primary-gold); font-size:9px">Semanas:</small>
                    <select id="num-semanas" onchange="cambiarSemanas()" style="width:45px">
                        <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4" selected>4</option><option value="5">5</option>
                    </select>
                </div>

                <input type="text" id="main-contrato" placeholder="ID Contrato..." oninput="autoGuardado()" style="width:100px">
                <button class="btn btn-gold" onclick="guardarEnFirebase()">‚òÅÔ∏è GUARDAR</button>
                <button class="btn" style="background:#333; color:white" onclick="cerrarSesion()">SALIR</button>
            </div>
        </header>

        <div id="main-grid" class="grid-container"></div>
    </div>

    <div id="modal-ajustes">
        <div class="ajustes-container">
            <h3 style="color:var(--primary-gold); margin-top:0">‚öôÔ∏è GESTI√ìN DE PRODUCTOS</h3>
            <div id="lista-precios-config"></div>
            <button class="btn btn-cyan" style="width:100%; margin-top:15px" onclick="agregarProductoNuevo()">+ AGREGAR PRODUCTO</button>
            <button class="btn btn-gold" style="width:100%; margin-top:10px" onclick="aplicarAjustes()">APLICAR Y REGENERAR</button>
            <button class="btn" style="width:100%; margin-top:10px; background:#333; color:white" onclick="toggleAjustes(false)">CANCELAR</button>
        </div>
    </div>

<script>
    // Config Firebase (Se asume la misma del usuario)
    const firebaseConfig = {
        apiKey: "AIzaSyBlbJPanxmKNq0NK3R6mzhMpBxOzA_qP7E",
        authDomain: "tabla-valores.firebaseapp.com",
        databaseURL: "https://tabla-valores-default-rtdb.firebaseio.com",
        projectId: "tabla-valores",
        storageBucket: "tabla-valores.firebasestorage.app",
        messagingSenderId: "880909110728",
        appId: "1:880909110728:web:b3c12dd212022825ab04fd"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = "";
    let productosBase = [
        { nombre: "Pollo Libra", precio: 9000 },
		{ nombre: "Huevo Und", precio: 450 },
        { nombre: "Molleja Libra", precio: 7000 },
		{ nombre: "Queso Libra", precio: 13000 },
        { nombre: "Carne Cerdo Kilo", precio: 21000 },
		{ nombre: "Carne res Kilo", precio: 26000 },
        { nombre: "Higado Kilo", precio: 18000 },
		{ nombre: "Tilapia Kilo", precio: 24000 },
        { nombre: "Leche Litro", precio: 3792 },
		{ nombre: "Yogurt Litro", precio: 5900 },
		{ nombre: "Pan Und", precio: 600 }
    ];

    const formatter = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 });
    function limpiarNumero(t) { return parseFloat(t.toString().replace(/\./g, '').replace(/[^0-9.-]+/g, "")) || 0; }

    // --- Auth & Init ---
    async function handleAuth(type) {
        const u = document.getElementById(type === 'login' ? 'user-login' : 'user-reg').value.trim().toLowerCase();
        const p = document.getElementById(type === 'login' ? 'pass-login' : 'pass-reg').value;
        if(!u || !p) return alert("Llenar campos");
        if(type === 'register') { await db.ref('users/'+u).set({password: p}); alert("Cuenta Creada"); toggleAuth(false); }
        else {
            const snap = await db.ref('users/'+u).once('value');
            if(snap.exists() && snap.val().password === p) { localStorage.setItem('elite_user', u); iniciarApp(u); }
            else alert("Acceso denegado");
        }
    }

    function toggleAuth(toReg) {
        document.getElementById('login-form').style.display = toReg ? 'none' : 'block';
        document.getElementById('reg-form').style.display = toReg ? 'block' : 'none';
    }

    function iniciarApp(user) {
        currentUser = user;
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        cargarBorrador();
    }

    function cerrarSesion() { localStorage.removeItem('elite_user'); location.reload(); }
    window.onload = () => { if(localStorage.getItem('elite_user')) iniciarApp(localStorage.getItem('elite_user')); };

    // --- Core Tables ---
    function initGrid() {
        const grid = document.getElementById('main-grid');
        const numSemanas = parseInt(document.getElementById('num-semanas').value);
        grid.innerHTML = '';
        for (let s = 1; s <= numSemanas; s++) {
            grid.innerHTML += `
                <div class="semana-card" id="card-${s}">
                    <h2 style="color:var(--primary-gold); margin:0 0 10px 0; font-size:1.2em">SEMANA ${s}</h2>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px">
                        <div><label style="font-size:9px">D√çAS:</label><input type="number" id="dias-${s}" oninput="calcular(${s}); autoGuardado()"></div>
                        <div><label style="font-size:9px">CUPOS:</label><input type="number" id="cupos-${s}" oninput="calcular(${s}); autoGuardado()"></div>
                        <div style="grid-column:span 2"><input type="text" id="pres-${s}" class="price-display" style="text-align:center; color:var(--success); font-size:1.3em; width:100%" readonly></div>
                    </div>
                    <table id="tabla-${s}">
                        <thead><tr><th>FAC</th><th>PRODUCTO</th><th style="width:40px">CANT</th><th>TOTAL</th></tr></thead>
                        <tbody>
                            ${productosBase.map((p, i) => `
                                <tr>
                                    <td><input type="text" id="fac-${s}-${i}" oninput="autoGuardado()" style="padding:2px"></td>
                                    <td style="color:var(--text-dim); max-width:80px; overflow:hidden">${p.nombre}</td>
                                    <td><input type="number" id="cant-${s}-${i}" oninput="calcular(${s}); autoGuardado()" style="padding:2px"></td>
                                    <td><input type="text" id="val-${s}-${i}" class="price-display" oninput="calcular(${s}); autoGuardado()" ${p.precio > 0 ? 'readonly' : ''} style="width:100%; font-size:10px"></td>
                                </tr>`).join('')}
                            <tr style="background:rgba(212,175,55,0.1)">
                                <td colspan="3" style="font-weight:bold">DISTRIBUIDORA</td>
                                <td><input type="text" id="dist-${s}" readonly class="price-display" style="width:100%"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>`;
        }
    }

    function cambiarSemanas() {
        if(confirm("Al cambiar la cantidad de semanas se regenerar√° la tabla. Aseg√∫rate de haber guardado tus cambios.")) {
            initGrid();
            autoGuardado();
        }
    }

    function calcular(s) {
        const d = parseFloat(document.getElementById(`dias-${s}`).value) || 0;
        const c = parseFloat(document.getElementById(`cupos-${s}`).value) || 0;
        const pres = d * c * 8094;
        document.getElementById(`pres-${s}`).value = formatter.format(pres);
        
        let gastoProductos = 0;
        productosBase.forEach((p, i) => {
            const cant = parseFloat(document.getElementById(`cant-${s}-${i}`).value) || 0;
            const inputVal = document.getElementById(`val-${s}-${i}`);
            if(p.precio > 0) {
                const sub = cant * p.precio;
                inputVal.value = formatter.format(sub);
                gastoProductos += sub;
            } else {
                gastoProductos += limpiarNumero(inputVal.value);
            }
        });

        let dist = Math.max(0, pres - gastoProductos); 
        document.getElementById(`dist-${s}`).value = formatter.format(dist);
        actualizarResumenData();
    }

    function actualizarResumenData() {
        const numSemanas = parseInt(document.getElementById('num-semanas').value);
        let sumProd = 0, sumDist = 0, sumPres = 0;
        let resumen = productosBase.map(p => ({ nombre: p.nombre, cant: 0, total: 0 }));

        for(let s=1; s<=numSemanas; s++) {
            const presVal = document.getElementById(`pres-${s}`);
            if(!presVal) continue;

            sumPres += limpiarNumero(presVal.value);
            sumDist += limpiarNumero(document.getElementById(`dist-${s}`).value);
            productosBase.forEach((p, i) => {
                const c = parseFloat(document.getElementById(`cant-${s}-${i}`).value) || 0;
                const v = limpiarNumero(document.getElementById(`val-${s}-${i}`).value);
                resumen[i].cant += c; resumen[i].total += v; sumProd += v;
            });
        }

        document.getElementById('summary-content').innerHTML = `
            <div style="padding: 10px; border: 1px solid #444; border-radius: 8px; margin-bottom:15px; font-size:10px">
                <b>CONTRATO:</b> ${document.getElementById('main-contrato').value || 'N/A'}<br>
                <b>MES:</b> ${document.getElementById('main-mes').value}<br>
                <b>SEMANAS EJECUTADAS:</b> ${numSemanas}
            </div>
            <table style="width:100%">
                <thead><tr><th>PRODUCTO</th><th>CANT</th><th>TOTAL</th></tr></thead>
                <tbody>
                    ${resumen.filter(r => r.total > 0).map(r => `
                        <tr><td>${r.nombre}</td><td>${r.cant.toFixed(1)}</td><td class="price-display">${formatter.format(r.total)}</td></tr>
                    `).join('')}
                    <tr style="border-top:1px solid #555">
                        <td colspan="2"><b>SUMA PRODUCTOS</b></td>
                        <td class="price-display"><b>${formatter.format(sumProd)}</b></td>
                    </tr>
                    <tr>
                        <td colspan="2"><b>DISTRIBUIDORA</b></td>
                        <td class="price-display">${formatter.format(sumDist)}</td>
                    </tr>
                    <tr style="background:rgba(0,242,255,0.15); font-weight:bold">
                        <td colspan="2" style="color:var(--accent-cyan)">SUBTOTAL EJECUTADO</td>
                        <td class="price-display" style="color:var(--accent-cyan)">${formatter.format(sumProd + sumDist)}</td>
                    </tr>
                </tbody>
            </table>
            <div style="margin-top:15px; text-align:right; border-top:2px solid var(--primary-gold); padding-top:10px">
                <small style="color:var(--text-dim)">TOTAL PRESUPUESTADO</small><br>
                <b style="font-size:1.5em; color:var(--primary-gold)">${formatter.format(sumPres)}</b>
            </div>`;
    }

    // --- Dynamic Adjustments ---
    function toggleAjustes(show) { 
        document.getElementById('modal-ajustes').style.display = show ? 'flex' : 'none'; 
        if(show) renderAjustesEdicion();
    }

    function renderAjustesEdicion() {
        const cont = document.getElementById('lista-precios-config');
        cont.innerHTML = `<div style="display:grid; grid-template-columns: 2fr 1fr 40px; gap:10px; margin-bottom:10px; font-weight:bold; color:var(--text-dim)"><span>Producto</span><span>Precio</span><span></span></div>`;
        productosBase.forEach((p, i) => {
            const div = document.createElement('div');
            div.style = "display:grid; grid-template-columns: 2fr 1fr 40px; gap:10px; margin-bottom:5px";
            div.innerHTML = `<input type="text" value="${p.nombre}" onchange="productosBase[${i}].nombre=this.value"><input type="number" value="${p.precio}" onchange="productosBase[${i}].precio=parseFloat(this.value)||0"><button class="btn btn-danger" onclick="eliminarProducto(${i})" style="padding:2px">X</button>`;
            cont.appendChild(div);
        });
    }

    function agregarProductoNuevo() { productosBase.push({ nombre: "Nuevo", precio: 0 }); renderAjustesEdicion(); }
    function eliminarProducto(index) { productosBase.splice(index, 1); renderAjustesEdicion(); }
    function aplicarAjustes() { initGrid(); toggleAjustes(false); autoGuardado(); }

    // --- UI Drawers ---
    function toggleDrawer(id, show) {
        document.getElementById(`drawer-${id}`).classList.toggle('open', show);
        document.getElementById('overlay').style.display = show ? 'block' : 'none';
        if(id === 'archivo' && show) listarArchivos();
    }

    function closeAllDrawers() {
        document.getElementById('drawer-archivo').classList.remove('open');
        document.getElementById('drawer-resumen').classList.remove('open');
        document.getElementById('overlay').style.display = 'none';
    }

    // --- Firebase & Storage ---
    async function guardarEnFirebase() {
        const mes = document.getElementById('main-mes').value;
        const con = document.getElementById('main-contrato').value || "S_N";
        const numSemanas = document.getElementById('num-semanas').value;
        const id = `${mes}_${con}`;
        const data = { mes, contrato: con, numSemanas, productosBase, semanas: {} };
        for(let s=1; s<=numSemanas; s++) {
            data.semanas[s] = {
                dias: document.getElementById(`dias-${s}`).value,
                cupos: document.getElementById(`cupos-${s}`).value,
                cants: productosBase.map((_, i) => document.getElementById(`cant-${s}-${i}`).value),
                vals: productosBase.map((_, i) => document.getElementById(`val-${s}-${i}`).value),
                facs: productosBase.map((_, i) => document.getElementById(`fac-${s}-${i}`).value)
            };
        }
        await db.ref(`files/${currentUser}/${id}`).set(data);
        alert("Sincronizaci√≥n completa");
    }

    async function listarArchivos() {
		const cont = document.getElementById('lista-guardados');
		cont.innerHTML = "Cargando...";
		try {
			const snap = await db.ref(`files/${currentUser}`).once('value');
			cont.innerHTML = "";
			if (!snap.exists()) {
				cont.innerHTML = "No hay registros";
				return;
			}
			snap.forEach(child => {
				const v = child.val();
				const key = child.key; // Esta es la ID √∫nica (Mes_Contrato)
				const div = document.createElement('div');
				div.style = "background:rgba(255,255,255,0.05); padding:10px; margin-bottom:8px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; border: 1px solid #333;";
				div.innerHTML = `
					<div style="cursor:pointer; flex-grow:1" onclick="cargarDesdeFirebase('${key}')">
						<b style="color:var(--primary-gold)">${v.mes}</b> - ${v.contrato} 
						<br><small style="color:var(--text-dim)">(${v.numSemanas || 4} semanas)</small>
					</div>
					<button class="btn btn-danger" onclick="eliminarDesdeFirebase('${key}')" style="padding: 5px 10px; margin-left:10px">üóëÔ∏è</button>
				`;
				cont.appendChild(div);
			});
		} catch (error) {
			console.error(error);
			cont.innerHTML = "Error al cargar archivos";
		}
	}

		async function eliminarDesdeFirebase(key) {
			// Confirmaci√≥n de seguridad
			if (confirm(`¬øEst√°s seguro de que deseas eliminar el registro "${key}"? Esta acci√≥n no se puede deshacer.`)) {
				try {
					await db.ref(`files/${currentUser}/${key}`).remove();
					alert("Registro eliminado con √©xito.");
					listarArchivos(); // Recargar la lista autom√°ticamente
				} catch (error) {
					console.error("Error al eliminar:", error);
					alert("No se pudo eliminar el registro. Int√©ntalo de nuevo.");
				}
			}
		}


    async function cargarDesdeFirebase(key) {
        const snap = await db.ref(`files/${currentUser}/${key}`).once('value');
        restaurarTodo(snap.val());
        closeAllDrawers();
    }

    function autoGuardado() {
        const data = { 
            mes: document.getElementById('main-mes').value, 
            contrato: document.getElementById('main-contrato').value, 
            numSemanas: document.getElementById('num-semanas').value,
            productosBase 
        };
        localStorage.setItem(`elite_config_${currentUser}`, JSON.stringify(data));
    }

    function cargarBorrador() {
        const saved = localStorage.getItem(`elite_config_${currentUser}`);
        if(saved) {
            const data = JSON.parse(saved);
            productosBase = data.productosBase || productosBase;
            document.getElementById('main-mes').value = data.mes;
            document.getElementById('main-contrato').value = data.contrato;
            document.getElementById('num-semanas').value = data.numSemanas || 4;
        }
        initGrid();
    }

    function restaurarTodo(data) {
        if(data.productosBase) productosBase = data.productosBase;
        document.getElementById('num-semanas').value = data.numSemanas || 4;
        initGrid();
        document.getElementById('main-mes').value = data.mes;
        document.getElementById('main-contrato').value = data.contrato;
        for(let s=1; s<=data.numSemanas; s++) {
            if(!data.semanas[s]) continue;
            document.getElementById(`dias-${s}`).value = data.semanas[s].dias;
            document.getElementById(`cupos-${s}`).value = data.semanas[s].cupos;
            data.semanas[s].cants.forEach((v, i) => { if(document.getElementById(`cant-${s}-${i}`)) document.getElementById(`cant-${s}-${i}`).value = v; });
            data.semanas[s].vals.forEach((v, i) => { if(document.getElementById(`val-${s}-${i}`)) document.getElementById(`val-${s}-${i}`).value = v; });
            data.semanas[s].facs.forEach((v, i) => { if(document.getElementById(`fac-${s}-${i}`)) document.getElementById(`fac-${s}-${i}`).value = v; });
            calcular(s);
        }
    }

    function exportExcel() {
        let csv = "Producto,Cantidad,Total\n";
        document.querySelectorAll('#summary-content tr').forEach(r => {
            const cols = r.querySelectorAll('td');
            if(cols.length > 0) csv += Array.from(cols).map(c => c.innerText.replace(/[$.,]/g, '')).join(",") + "\n";
        });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
        a.download = `Resumen_${document.getElementById('main-mes').value}.csv`;
        a.click();
    }
</script>
</body>
</html>