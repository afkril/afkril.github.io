<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZAN|Tabla_Valores</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-body: #0a0a0c;
            --bg-card: rgba(30, 30, 35, 0.95);
            --primary-gold: #d4af37;
            --accent-cyan: #00f2ff;
            --text-main: #e2e8f0;
            --text-dim: #94a3b8;
            --danger: #ff4655;
            --success: #00ff88;
            --border-color: rgba(212, 175, 55, 0.3);
            --warning: #ffaa00;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            background-image: radial-gradient(circle at 50% 0%, #1a1a2e 0%, #0a0a0c 100%);
            margin: 0; padding: 0; color: var(--text-main); font-size: 11px; min-height: 100vh;
        }

        .semana-card.excedido {
            border: 2px solid var(--danger);
            box-shadow: 0 0 15px rgba(255, 70, 85, 0.3);
            background: rgba(40, 20, 20, 0.95);
        }

        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .auth-box { background: var(--bg-card); padding: 30px; border-radius: 20px; border: 1px solid var(--primary-gold); width: 90%; max-width: 340px; text-align: center; }
        
        #app-content { display: none; padding: 10px; }
        .top-bar { background: var(--bg-card); padding: 10px 15px; border-radius: 12px; border: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }

        .user-info { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.3); padding: 5px 12px; border-radius: 20px; border: 1px solid #333; }
        .led-indicator { width: 10px; height: 10px; border-radius: 50%; transition: 0.3s; }
        .led-red { background-color: var(--danger); box-shadow: 0 0 10px var(--danger); }
        .led-green { background-color: var(--success); box-shadow: 0 0 10px var(--success); }
        .username-display { font-weight: bold; color: var(--primary-gold); text-transform: uppercase; font-size: 15px; }

        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 15px; }
        .semana-card { background: var(--bg-card); padding: 12px; border-radius: 12px; border: 1px solid var(--border-color); transition: 0.3s; }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0 4px; font-size: 11px; }
        td, th { padding: 3px 5px; background: rgba(255,255,255,0.02); border-radius: 4px; }
        input, select { background: rgba(0,0,0,0.4); border: 1px solid #444; color: white; padding: 4px; border-radius: 4px; width: 100%; box-sizing: border-box; }
        
        .total-editable { 
            color: var(--accent-cyan) !important; 
            font-weight: bold !important; 
            text-align: right; 
            background: rgba(0, 242, 255, 0.05) !important;
            border: 1px solid rgba(0, 242, 255, 0.2) !important;
			width: 110%; /* Ocupa todo el ancho de su celda */
        }
        .price-hidden { display: none; }
        .price-display {
			color: var(--primary-gold);
			font-family: monospace;
			font-weight: bold;
			text-align: right;
			border: none;
			background: transparent;
			width: 100%; /* Ocupa todo el ancho de su celda */
			box-sizing: border-box;
		}

		.row-distribuidora {
			color: white;
			background:rgba(212,175,55,0.1) !important; /* Un toque verde muy sutil */
			height: 40px;
		}
        .drawer { position: fixed; top: 0; width: 85%; max-width: 320px; height: 100%; background: var(--bg-card); z-index: 2000; transition: 0.4s; padding: 20px; overflow-y: auto; }
        #drawer-archivo { left: -350px; border-right: 1px solid var(--primary-gold); }
        #drawer-archivo.open { left: 0; }
        #drawer-resumen { right: -350px; border-left: 1px solid var(--accent-cyan); }
        #drawer-resumen.open { right: 0; }
        .drawer-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); display: none; z-index: 1999; }

        #modal-ajustes { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 3000; align-items: center; justify-content: center; }
        .ajustes-container { background:#151518; width: 95%; max-width: 450px; padding: 20px; border-radius: 15px; border: 1px solid var(--primary-gold); }

        .btn { padding: 5px 10px; border-radius: 66px; font-weight: 800; cursor: pointer; border: 3px solid transparent; text-transform: uppercase; font-size: 9px; transition: 0.3s; }
        .btn-gold { background: var(--primary-gold); color: black; }
        .btn-cyan { background: var(--accent-cyan); color: black; }
        .btn-danger { background: var(--danger); color: white; border: none; }
		
		
		
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box" id="login-form">
            <h2 style="color:var(--primary-gold)">INGRESAR</h2>
            <input type="text" id="user-login" placeholder="Usuario">
            <input type="password" id="pass-login" placeholder="Contrase√±a" style="margin: 10px 0 20px 0">
            <button class="btn btn-gold" style="width:100%" onclick="handleAuth('login')">ENTRAR</button>
            <p onclick="toggleAuth(true)" style="font-size: 15px; margin-top: 15px; cursor: pointer; color: var(--accent-cyan)">NO TIENE CUENTA? REGISTRAR CUENTA</p>
        </div>
        <div class="auth-box" id="reg-form" style="display:none">
            <h2 style="color:var(--accent-cyan)">NUEVO REGISTRO</h2>
            <input type="text" id="user-reg" placeholder="Usuario">
            <input type="password" id="pass-reg" placeholder="Contrase√±a" style="margin: 10px 0 20px 0">
            <button class="btn btn-cyan" style="width:100%" onclick="handleAuth('register')">CREAR USUARIO</button>
            <p onclick="toggleAuth(false)" style="font-size: 15px; margin-top: 15px; cursor: pointer; color: var(--primary-gold)">VOLVER AL LOGIN PRAR INGRESAR</p>
        </div>
    </div>

    <div id="app-content">
        <div class="drawer-overlay" id="overlay" onclick="closeAllDrawers()"></div>
        
        <header class="top-bar">
            <div style="display:flex; gap:8px;">
                <button class="btn" style="border:1px solid var(--primary-gold); color:var(--primary-gold)" onclick="toggleDrawer('archivo', true)">üìÇ ARCHIVO</button>
                <button class="btn btn-cyan" onclick="toggleDrawer('resumen', true)">üìä RESUMEN</button>
                <button class="btn" style="background:#9C9492; border: 1px solid #4444;" onclick="toggleAjustes(true)">‚öôÔ∏è AJUSTES</button>
                <button class="btn" style="background:#2e7d32; color:white; border: 1px solid #1b5e20;" onclick="exportarTablasCompletas()">üìä üì• EXCEL</button>
                <button class="btn" style="background:#0277bd; color:white; border: 1px solid #01579b;" onclick="document.getElementById('import-input').click()">üì• IMPORTAR EXCEL</button>
                <input type="file" id="import-input" style="display:none" accept=".csv, .xlsx, .xls" onchange="importarExcel(this)">
            </div>

            <div class="user-info">
                <div id="sync-led" class="led-indicator led-green"></div>
                <span id="display-user" class="username-display">USUARIO</span>
            </div>

            <div style="display:flex; gap:5px; align-items:center">
                <small>SEM:</small>
                <select id="num-semanas" onchange="cambiarSemanas()" style="width:45px">
                    <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4" selected>4</option><option value="5">5</option>
                </select>
                <select id="main-mes" onchange="marcarCambio()"><option>Enero</option><option>Febrero</option><option>Marzo</option><option>Abril</option><option>Mayo</option><option>Junio</option><option>Julio</option><option>Agosto</option><option>Septiembre</option><option>Octubre</option><option>Noviembre</option><option>Diciembre</option></select>
                <input type="text" id="main-contrato" placeholder="ID Contrato" style="width:90px" oninput="marcarCambio()">
                <button class="btn btn-gold" onclick="guardarFirebase()">‚òÅÔ∏è GUARDAR</button>
                <button class="btn btn-danger" style="padding: 5px;" onclick="cerrarSesion()">‚ùå</button>
            </div>
        </header>

        <div id="main-grid" class="grid-container"></div>
    </div>

    <div class="drawer" id="drawer-resumen">
        <h3 style="color: var(--accent-cyan)">üìä AN√ÅLISIS DE GASTOS</h3>
        <div id="summary-content"></div>
        <canvas id="chartGasto" style="margin-top:20px"></canvas>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px;">
            <button class="btn btn-cyan" onclick="exportarTablasCompletas()">üì• EXCEL RESUMEN</button>
            <button class="btn btn-gold" onclick="window.print()">üñ®Ô∏è IMPRIMIR</button>
        </div>
    </div>

    <div class="drawer" id="drawer-archivo">
        <h3 style="color: var(--primary-gold)">üìÇ REGISTROS EN NUBE</h3>
        <div id="lista-archivos"></div>
    </div>

    <div id="modal-ajustes">
        <div class="ajustes-container">
            <h3 style="color:var(--primary-gold)">‚öôÔ∏è CONFIGURACI√ìN PRODUCTOS</h3>
            <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                <label style="font-size: 10px; color: var(--accent-cyan);">VALOR RACION HCB ($):</label>
                <input type="number" id="cfg-valor-cupo" value="8094" onchange="marcarCambio()" style="font-size: 12px; color: var(--success);">
            </div>
            <h4 style="margin: 10px 0; font-size: 10px;">LISTADO DE PRODUCTOS BASE</h4>
            <div id="lista-config-prod" style="max-height: 300px; overflow-y: auto; margin-bottom:10px"></div>
            <button class="btn btn-cyan" style="width:100%; margin-bottom:2px" onclick="agregarProd()">+ AGREGAR NUEVO PRODUCTO</button>
            <button class="btn btn-gold" style="width:100%" onclick="aplicarAjustes()">APLICAR Y REGENERAR</button>
            <button class="btn" style="width:100%; margin-top:10px; background:#333" onclick="toggleAjustes(false)">CERRAR</button>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBlbJPanxmKNq0NK3R6mzhMpBxOzA_qP7E",
        authDomain: "tabla-valores.firebaseapp.com",
        databaseURL: "https://tabla-valores-default-rtdb.firebaseio.com",
        projectId: "tabla-valores",
        storageBucket: "tabla-valores.firebasestorage.app",
        messagingSenderId: "880909110728",
        appId: "1:880909110728:web:b3c12dd212022825ab04fd"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = "";
    let valorCupoBase = 8094;
    let chartInstance = null;
    let productosBase = [
        { nombre: "Pollo Libra", precio: 9000, cl: true },
        { nombre: "Huevo Und", precio: 450, cl: true },
        { nombre: "Molleja Libra", precio: 7000, cl: true },
        { nombre: "Queso Libra", precio: 13000, cl: false },
        { nombre: "Carne Cerdo Kilo", precio: 13000, cl: true },
        { nombre: "Carne Res Kilo", precio: 26000, cl: true },
        { nombre: "Higado Kilo", precio: 18000, cl: true },
        { nombre: "Tilapia Kilo", precio: 24000, cl: true },
        { nombre: "Leche Litro", precio: 3792, cl: true },
        { nombre: "Yogurt Litro", precio: 5900, cl: true },
        { nombre: "Pan Und", precio: 600, cl: false }
    ];

    const formatter = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 });
    function limpiarNum(t) { return parseFloat(t.toString().replace(/[$.,]/g, "").replace(/[^0-9.-]+/g, "")) || 0; }

    function marcarCambio() {
        if(document.getElementById('sync-led')) document.getElementById('sync-led').className = 'led-indicator led-red';
        guardarLocal();
    }

    window.onload = () => {
        const session = localStorage.getItem('elite_user');
        if(session) iniciarApp(session);
    };

    function handleAuth(type) {
        const uInput = document.getElementById(type === 'login' ? 'user-login' : 'user-reg');
        const pInput = document.getElementById(type === 'login' ? 'pass-login' : 'pass-reg');
        const u = uInput.value.trim().toLowerCase();
        const p = pInput.value;
        if(type === 'register') {
            db.ref('users/'+u).set({password: p}); alert("Registrado"); toggleAuth(false);
        } else {
            db.ref('users/'+u).once('value', s => {
                if(s.exists() && s.val().password === p) {
                    localStorage.setItem('elite_user', u);
                    iniciarApp(u);
                } else alert("Credenciales incorrectas");
            });
        }
    }

    function iniciarApp(u) {
        currentUser = u;
        document.getElementById('display-user').innerText = u;
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        cargarLocal();
    }

    function cerrarSesion() { localStorage.removeItem('elite_user'); location.reload(); }

    function initGrid(preservarDatos = false) {
        if (preservarDatos) { guardarLocal(); }

        const grid = document.getElementById('main-grid');
        const numSemSelect = document.getElementById('num-semanas');
        const semanas = numSemSelect ? parseInt(numSemSelect.value) : 4;
        
        grid.innerHTML = ''; 
        
        for(let s=1; s<=semanas; s++) {
		
            grid.innerHTML += `
                <div class="semana-card" id="card-${s}">
					<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
						<h3 style="color:var(--primary-gold); margin:0">SEMANA ${s}</h3>
					
						<button class="btn" 
							style="background:rgba(255,70,85,0.1); color:var(--danger); border:1px solid var(--danger); font-size:9px; padding:2px 6px;" 
							onclick="limpiarSemana(${s})">
						üßπ LIMPIAR
						</button>
					</div>
					
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:10px">
                        <input type="number" id="dias-${s}" placeholder="D√≠as" oninput="calcular(${s}); marcarCambio()">
                        <input type="number" id="cupos-${s}" placeholder="Cupos" oninput="calcular(${s}); marcarCambio()">
                        <input type="text" id="pres-${s}" class="price-display" style="grid-column:span 2; font-size:1.6em; text-align:center; color:var(--success)" readonly>
                    </div>
                    <table>
                        <thead><tr><th>FAC</th><th>PRODUCTO</th><th>CANT</th><th>TOTAL</th></tr></thead>
                        <tbody>
                            ${productosBase.map((p, i) => `
                                <tr>
                                    <td><input type="text" id="fac-${s}-${i}" oninput="marcarCambio()"></td>
                                    <td>
                                        ${p.nombre} ${p.cl ? '<span style="color:var(--accent-cyan); font-size:8px">CL</span>' : ''}
                                        <input type="number" id="punit-${s}-${i}" value="${p.precio}" class="price-hidden">
                                    </td>
                                    <td><input type="number" id="cant-${s}-${i}" oninput="calcular(${s}); marcarCambio()"></td>
                                    <td><input type="text" id="val-${s}-${i}" class="total-editable" oninput="ajustarPrecioInverso(${s}, ${i}); marcarCambio()"></td>
                                </tr>`).join('')}
                            <tr class="row-distribuidora">
							<td colspan="2" style="width: 40%; padding-left: 5px;">
								<b style="font-size: 9px;">DISTRIBUIDORA.</b>
							</td>
							<td colspan="2" style="width: 70%;">
								<input type="text" id="dist-${s}" class="price-display" 
									   style="color:var(--primary-gold); font-size: 13px; width: 100%; padding-right: 10px;" 
									   readonly>
							</td>
						</tr>
                        </tbody>
                    </table>
                </div>`;
        }

        if (preservarDatos) {
            const saved = localStorage.getItem(`elite_draft_${currentUser}`);
            if(saved) {
                const data = JSON.parse(saved);
                for(let s=1; s<=semanas; s++) {
                    if(!data.semanas || !data.semanas[s]) {
                        calcular(s);
                        continue; 
                    }
                    
                    const semData = data.semanas[s];
                    if(document.getElementById(`dias-${s}`)) document.getElementById(`dias-${s}`).value = semData.d || "";
                    if(document.getElementById(`cupos-${s}`)) document.getElementById(`cupos-${s}`).value = semData.c || "";
                    
                    productosBase.forEach((pb, i) => {
                        const item = semData.items ? semData.items[pb.nombre] : null;
                        if(item) {
                            if(document.getElementById(`fac-${s}-${i}`)) document.getElementById(`fac-${s}-${i}`).value = item.f || "";
                            if(document.getElementById(`cant-${s}-${i}`)) document.getElementById(`cant-${s}-${i}`).value = item.q || "";
                            if(document.getElementById(`punit-${s}-${i}`)) document.getElementById(`punit-${s}-${i}`).value = pb.precio;
                        }
                    });
                    calcular(s);
                }
            }
        } else {
            actualizarResumen();
        }
    }

    function cambiarSemanas() { initGrid(true); marcarCambio(); }

    function ajustarPrecioInverso(s, i) {
        const totalIngresado = limpiarNum(document.getElementById(`val-${s}-${i}`).value);
        const cantidad = parseFloat(document.getElementById(`cant-${s}-${i}`).value) || 0;
        if (cantidad > 0) {
            document.getElementById(`punit-${s}-${i}`).value = totalIngresado / cantidad;
        }
        calcular(s, false); 
    }

    function calcular(s, formatearTotal = true) {
        const d = parseFloat(document.getElementById(`dias-${s}`).value) || 0;
        const c = parseFloat(document.getElementById(`cupos-${s}`).value) || 0;
        const pres = d * c * valorCupoBase;
        const presElem = document.getElementById(`pres-${s}`);
        if(presElem) presElem.value = formatter.format(pres);

        let sumaProd = 0;
        productosBase.forEach((p, i) => {
            const cant = parseFloat(document.getElementById(`cant-${s}-${i}`).value) || 0;
            const pUnit = parseFloat(document.getElementById(`punit-${s}-${i}`).value) || 0;
			
            const total = cant * pUnit;
            if (formatearTotal) {
                const inputVal = document.getElementById(`val-${s}-${i}`);
                if(inputVal) inputVal.value = formatter.format(total);
            }
            sumaProd += total;
        });

        const dist = pres - sumaProd;
        const distElem = document.getElementById(`dist-${s}`);
        if(distElem) distElem.value = formatter.format(dist);
        const card = document.getElementById(`card-${s}`);
        if(card) card.classList.toggle('excedido', dist < 0);
        actualizarResumen();
    }

    function actualizarResumen() {
    const numSemSelect = document.getElementById('num-semanas');
    if(!numSemSelect) return;
    const semanas = parseInt(numSemSelect.value);
    
    let tPres = 0, tProdCL = 0, tProdOtros = 0;
    // Inicializamos el reporte con cantidad (c) y total monetario (t)
    let rProd = productosBase.map(p => ({ n: p.nombre, c: 0, t: 0, cl: p.cl }));

    for(let s=1; s<=semanas; s++) {
        const pVal = document.getElementById(`pres-${s}`);
        if(!pVal) continue;
        tPres += limpiarNum(pVal.value);
        
        productosBase.forEach((p, i) => {
            const vInput = document.getElementById(`val-${s}-${i}`);
            const cInput = document.getElementById(`cant-${s}-${i}`);
            if(!vInput) return;
            
            const t = limpiarNum(vInput.value);
            const c = parseFloat(cInput.value) || 0;
            
            rProd[i].t += t;
            rProd[i].c += c; // Sumatoria de cantidades f√≠sicas
            
            if(p.cl) tProdCL += t; else tProdOtros += t;
        });
    }

    const tDist = tPres - tProdCL - tProdOtros;
    const porcCL = tPres > 0 ? (tProdCL / tPres) * 100 : 0;
    const ledColor = porcCL >= 30 ? 'var(--success)' : 'var(--danger)';

    const sumCont = document.getElementById('summary-content');
    if(sumCont) {
        sumCont.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; margin-bottom: 15px; border: 1px solid ${ledColor}">
                <div>
                    <small style="display:block; color:var(--text-dim)">% COMPRAS LOCALES (CL)</small>
                    <b style="font-size: 1.3em; color:${ledColor}">${porcCL.toFixed(1)}%</b>
                </div>
                <div style="width: 15px; height: 15px; background: ${ledColor}; border-radius: 50%; box-shadow: 0 0 10px ${ledColor}"></div>
            </div>

            <table style="width:100%">
                <thead>
                    <tr>
                        <th>PRODUCTO</th>
                        <th style="text-align:center">CL</th>
                        <th style="text-align:center">CANT. TOTAL</th> <th style="text-align:right">TOTAL $</th>
                    </tr>
                </thead>
                <tbody>
                    ${rProd.filter(x => x.t > 0 || x.c > 0).map(x => `
                        <tr>
                            <td>${x.n}</td>
                            <td style="text-align:center; font-size:8px">${x.cl ? '‚úÖ' : '‚ùå'}</td>
                            <td style="text-align:center; color:var(--accent-cyan); font-weight:bold">${x.c.toLocaleString()}</td> <td class="price-display">${formatter.format(x.t)}</td>
                        </tr>`).join('')}
                    
                    <tr style="border-top:1px solid #555; color:var(--accent-cyan)">
                        <td colspan="2"><b>TOTAL CL</b></td>
                        <td></td>
                        <td class="price-display"><b>${formatter.format(tProdCL)} (${porcCL.toFixed(1)}%)</b></td>
                    </tr>
                    <tr style="color:var(--text-dim)">
                        <td colspan="2">OTROS PRODUCTOS</td>
                        <td></td>
                        <td class="price-display">${formatter.format(tProdOtros)}</td>
                    </tr>
                    <tr>
                        <td colspan="2"><b style="color:var(--success)">DISTRIBUIDORA</b></td>
                        <td></td>
                        <td class="price-display" style="color:var(--success)">${formatter.format(tDist)}</td>
                    </tr>
                </tbody>
            </table>
            
            <div style="margin-top:15px; text-align:right; border-top:2px solid var(--primary-gold); padding-top:10px">
                <small>PRESUPUESTO TOTAL MES</small><br>
                <b style="font-size:1.5em; color:var(--primary-gold)">${formatter.format(tPres)}</b>
            </div>`;
    }
    renderChart(rProd.filter(x => x.t > 0), tDist);
}

    function renderChart(prods, distVal) {
        const chartCanvas = document.getElementById('chartGasto');
        if(!chartCanvas) return;
        const ctx = chartCanvas.getContext('2d');
        const labels = prods.map(p => p.n); labels.push("Distribuidora");
        const data = prods.map(p => p.t); data.push(Math.max(0, distVal));

        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: { labels, datasets: [{ data, backgroundColor: ['#d4af37', '#00f2ff', '#00ff88', '#ff4655', '#9c27b0', '#ff9800'] }] },
            options: { plugins: { legend: { position: 'bottom', labels: { color: '#fff', font: { size: 8 } } } } }
        });
    }

    function exportarTablasCompletas() {
		const mes = document.getElementById('main-mes').value;
		const contrato = document.getElementById('main-contrato').value;
		const numSemanas = parseInt(document.getElementById('num-semanas').value);
		
		// Encabezado principal
		let csv = "\uFEFFINFORME DE CONTROL;ZAN - TABLA VALORES\n";
		csv += `MES;${mes};CONTRATO;${contrato}\n\n`;

		for (let s = 1; s <= numSemanas; s++) {
			// Extraer metadatos de la semana
			const dias = document.getElementById(`dias-${s}`)?.value || "0";
			const cupos = document.getElementById(`cupos-${s}`)?.value || "0";
			const presupuesto = limpiarNum(document.getElementById(`pres-${s}`)?.value || "0");

			// Fila de encabezado de semana con sus datos generales
			csv += `--- SEMANA ${s} ---\n`;
			csv += `DIAS ATENCI√ìN;CUPOS ATENDIDOS;VALOR PRESUPUESTADO\n`;
			csv += `${dias};${cupos};${presupuesto}\n\n`;

			// Encabezado de tabla de productos
			csv += `FACTURA;PRODUCTO;CANTIDAD;VALOR TOTAL\n`;
			
			productosBase.forEach((p, i) => {
				const fac = document.getElementById(`fac-${s}-${i}`)?.value || "N/A";
				const cant = document.getElementById(`cant-${s}-${i}`)?.value || "0";
				const val = limpiarNum(document.getElementById(`val-${s}-${i}`)?.value || "0");
				csv += `${fac};${p.nombre};${cant};${val}\n`;
			});

			// Fila de distribuidora
			const dist = limpiarNum(document.getElementById(`dist-${s}`)?.value || "0");
			csv += `;;DISTRIBUIDORA;${dist}\n\n`;
		}

		const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
		const link = document.createElement("a");
		link.href = URL.createObjectURL(blob);
		link.download = `Reporte_${mes}_${contrato}.csv`;
		link.click();
	}

    function importarExcel(input) {
		if (!input.files[0]) return;
		const reader = new FileReader();

		reader.onload = function(e) {
			try {
				const data = e.target.result;
				const workbook = XLSX.read(data, { type: 'binary' });
				const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
				const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

				// 1. CARGAR ENCABEZADOS (MES Y CONTRATO)
				// Buscamos en las primeras filas el formato: MES;Enero;CONTRATO;123
				rows.slice(0, 5).forEach(fila => {
					const f = fila.map(c => String(c).toUpperCase());
					if (f.includes("MES")) {
						document.getElementById('main-mes').value = fila[f.indexOf("MES") + 1];
					}
					if (f.includes("CONTRATO")) {
						document.getElementById('main-contrato').value = fila[f.indexOf("CONTRATO") + 1];
					}
				});

				// 2. DETECTAR TOTAL DE SEMANAS EN EL ARCHIVO
				let maxSemanaEnArchivo = 0;
				rows.forEach(fila => {
					const texto = String(fila[0]).toUpperCase();
					if (texto.includes("SEMANA")) {
						const num = parseInt(texto.replace(/[^0-9]/g, ""));
						if (num > maxSemanaEnArchivo) maxSemanaEnArchivo = num;
					}
				});

				// Actualizar selector de semanas y regenerar grid si es necesario
				if (maxSemanaEnArchivo > 0) {
					document.getElementById('num-semanas').value = maxSemanaEnArchivo;
					initGrid(false); // Regeneramos la interfaz para recibir los datos
				}

				// 3. PROCESAR DATOS POR SEMANA
				let semanaActual = 0;
				rows.forEach((fila) => {
					if (!fila || fila.length === 0) return;
					const textoFila = fila.map(c => String(c).toUpperCase()).join(" ");

					// Detectar cambio de semana
					if (textoFila.includes("SEMANA")) {
						const match = textoFila.match(/SEMANA\s+(\d+)/);
						if (match) semanaActual = parseInt(match[1]);
						return;
					}

					if (semanaActual > 0) {
						// Cargar D√≠as, Cupos y Presupuesto
						// Si la fila tiene n√∫meros y la anterior fue "DIAS ATENCI√ìN"
						if (!isNaN(fila[0]) && fila[0] !== "" && !textoFila.includes("FACTURA")) {
							const dInput = document.getElementById(`dias-${semanaActual}`);
							const cInput = document.getElementById(`cupos-${semanaActual}`);
							if (dInput) dInput.value = fila[0];
							if (cInput) cInput.value = fila[1];
						}

						// Cargar Productos
						productosBase.forEach((p, i) => {
							if (textoFila.includes(p.nombre.toUpperCase())) {
								const facInput = document.getElementById(`fac-${semanaActual}-${i}`);
								const cantInput = document.getElementById(`cant-${semanaActual}-${i}`);
								const valInput = document.getElementById(`val-${semanaActual}-${i}`);

								if (facInput) facInput.value = fila[0] || "";
								if (cantInput) cantInput.value = fila[2] || "0";
								if (valInput) {
									valInput.value = fila[3] || "0";
									// Usamos el ajuste inverso para que el precio unitario sea coherente
									ajustarPrecioInverso(semanaActual, i);
								}
							}
						});
					}
				});

				// 4. RECALCULAR FINAL
				for (let s = 1; s <= maxSemanaEnArchivo; s++) {
					calcular(s);
				}

				alert("‚úÖ Importaci√≥n completa: Mes, Contrato, Semanas y Datos actualizados.");
				marcarCambio();

			} catch (error) {
				console.error(error);
				alert("‚ùå Error cr√≠tico: El formato del archivo no es compatible.");
			}
		};
		reader.readAsBinaryString(input.files[0]);
	}
	
	function limpiarSemana(s) {
		if (confirm(`‚ö†Ô∏è¬øEst√°s seguro de borrar FACTURAS y CANTIDADES de la SEMANA ${s}?‚ö†Ô∏è`)) {
			productosBase.forEach((p, i) => {
				const cantInput = document.getElementById(`cant-${s}-${i}`);
				if (cantInput) {
					cantInput.value = ""; // Limpiamos el valor
				}
				// Limpia las facturas (AQU√ç EST√Å EL AJUSTE)
				const facInput = document.getElementById(`fac-${s}-${i}`);
				if (facInput) {
					facInput.value = ""; 
				}
			});
			
			// Recalculamos la semana para que los totales y la distribuidora se actualicen a 0
			calcular(s);
			marcarCambio(); // Notificamos que hubo un cambio para el guardado
		}
	}

    function guardarLocal() {
        const semanas = parseInt(document.getElementById('num-semanas').value);
        const data = {
            mes: document.getElementById('main-mes').value,
            contrato: document.getElementById('main-contrato').value,
            numSemanas: semanas,
            valorCupo: valorCupoBase,
            productosBase,
            semanas: {}
        };
        for(let s=1; s<=semanas; s++) {
            data.semanas[s] = {
                d: document.getElementById(`dias-${s}`)?.value || "",
                c: document.getElementById(`cupos-${s}`)?.value || "",
                items: {}
            };
			
            productosBase.forEach((p, i) => {
                data.semanas[s].items[p.nombre] = {
                    f: document.getElementById(`fac-${s}-${i}`)?.value || "",
                    q: document.getElementById(`cant-${s}-${i}`)?.value || "",
                    p: document.getElementById(`punit-${s}-${i}`)?.value || p.precio
                };
            });
        }
        localStorage.setItem(`elite_draft_${currentUser}`, JSON.stringify(data));
    }

    function cargarLocal() {
        const saved = localStorage.getItem(`elite_draft_${currentUser}`);
        if(saved) restaurar(JSON.parse(saved)); else initGrid();
    }

    function restaurar(data) {
        productosBase = data.productosBase || productosBase;
        valorCupoBase = data.valorCupo || 8094;
        document.getElementById('main-mes').value = data.mes;
        document.getElementById('main-contrato').value = data.contrato || "";
        document.getElementById('num-semanas').value = data.numSemanas || 4;
        
        initGrid(); 

        for(let s=1; s<=data.numSemanas; s++) {
            if(!data.semanas || !data.semanas[s]) continue;
            const diasInput = document.getElementById(`dias-${s}`);
            const cuposInput = document.getElementById(`cupos-${s}`);
            if(diasInput) diasInput.value = data.semanas[s].d || "";
            if(cuposInput) cuposInput.value = data.semanas[s].c || "";
            
            if(data.semanas[s].items) {
                productosBase.forEach((pb, i) => {
                    const item = data.semanas[s].items[pb.nombre];
                    if(item) {
                        if(document.getElementById(`fac-${s}-${i}`)) document.getElementById(`fac-${s}-${i}`).value = item.f || "";
                        if(document.getElementById(`cant-${s}-${i}`)) document.getElementById(`cant-${s}-${i}`).value = item.q || "";
						
						const inputPUnit = document.getElementById(`punit-${s}-${i}`);
							if(inputPUnit) {
								inputPUnit.value = item.p || pb.precio; 
							}
                        }
                });
            }
            calcular(s);
        }
        if(document.getElementById('sync-led')) document.getElementById('sync-led').className = 'led-indicator led-green';
    }

    async function guardarFirebase() {
        const id = `${document.getElementById('main-mes').value}_${document.getElementById('main-contrato').value}`.replace(/\s+/g, '_');
        const data = JSON.parse(localStorage.getItem(`elite_draft_${currentUser}`));
        await db.ref(`files/${currentUser}/${id}`).set(data);
        alert("Sincronizado con Nube ‚òÅÔ∏è");
        if(document.getElementById('sync-led')) document.getElementById('sync-led').className = 'led-indicator led-green';
    }

    function toggleAuth(toReg) {
        document.getElementById('login-form').style.display = toReg ? 'none' : 'block';
        document.getElementById('reg-form').style.display = toReg ? 'block' : 'none';
    }
    function toggleDrawer(id, show) {
        document.getElementById(`drawer-${id}`).classList.toggle('open', show);
        document.getElementById('overlay').style.display = show ? 'block' : 'none';
        if(id === 'archivo' && show) listarCloud();
        if(id === 'resumen' && show) actualizarResumen();
    }
    function closeAllDrawers() { toggleDrawer('archivo', false); toggleDrawer('resumen', false); }
    
    function toggleAjustes(show) {
        document.getElementById('modal-ajustes').style.display = show ? 'flex' : 'none';
        if(show) {
            actualizarListaAjustes();
        }
    }

    function actualizarListaAjustes() {
        const cont = document.getElementById('lista-config-prod');
        cont.innerHTML = productosBase.map((p, i) => `
            <div style="display:flex; gap:1px; margin-bottom:1px; align-items:center; background:rgba(255,255,255,0.03); padding:1px; border-radius:500px">
                <input type="text" value="${p.nombre}" onchange="productosBase[${i}].nombre=this.value" style="flex:2">
                <input type="number" value="${p.precio}" style="width:70px" onchange="productosBase[${i}].precio=parseFloat(this.value)">
                <label style="font-size:7px; text-align:center; min-width:30px">
                    CL<br>
                    <input type="checkbox" ${p.cl ? 'checked' : ''} onchange="productosBase[${i}].cl=this.checked">
                </label>
                <button class="btn-danger" style="padding: 5px;" onclick="eliminarProducto(${i})">üóëÔ∏è</button>
            </div>`).join('');
    }
    
    function aplicarAjustes() { 
        const valCupoInput = document.getElementById('cfg-valor-cupo');
        if(valCupoInput) valorCupoBase = parseFloat(valCupoInput.value); 
        initGrid(true); 
        toggleAjustes(false); 
        alert("¬°Precios y productos actualizados en todas las tablas!");
    }

    function agregarProd() { 
        productosBase.push({nombre: "Nuevo Producto", precio: 0, cl: false}); 
        actualizarListaAjustes();
    }

    function eliminarProducto(index) {
        if(confirm("¬øEliminar este producto? Esto afectar√° a todas las semanas.")) {
            productosBase.splice(index, 1);
            actualizarListaAjustes();
        }
    }

    async function listarCloud() {
        const cont = document.getElementById('lista-archivos');
        const snap = await db.ref(`files/${currentUser}`).once('value');
        cont.innerHTML = "";
        snap.forEach(child => {
            const v = child.val();
            const div = document.createElement('div');
            div.style = "background:rgba(255,255,255,0.05); padding:10px; margin-bottom:8px; border-radius:8px; display:flex; justify-content:space-between; align-items:center";
            div.innerHTML = `<div onclick="cargarArchivo('${child.key}')\" style=\"cursor:pointer\"><b>${v.mes}</b> - ${v.contrato}</div>
                             <button class=\"btn-danger\" style=\"padding:4px; border-radius:4px\" onclick=\"borrarArchivo('${child.key}')\">üóëÔ∏è</button>`;
            cont.appendChild(div);
        });
    }

    async function cargarArchivo(k) {
        const snap = await db.ref(`files/${currentUser}/${k}`).once('value');
        restaurar(snap.val()); closeAllDrawers();
    }

    async function borrarArchivo(k) {
        if(confirm("¬øEliminar registro de la nube?")) await db.ref(`files/${currentUser}/${k}`).remove().then(listarCloud);
    }
</script>
</body>
</html>
