<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token_MOONBOX</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #0b0915;
            --card: rgba(255, 255, 255, 0.04);
            --cyan: #00e5ff;
            --purple: #8a4fff;
            --green: #2ecc71;
            --gold: #c5a059;
            --danger: #ff4444;
            --text: #ffffff;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            background-image: radial-gradient(circle at 50% 0%, #1a1635, #0b0915);
            color: var(--text);
            margin: 0; padding: 20px;
            display: flex; justify-content: center;
            min-height: 100vh;
        }

        .container { width: 100%; max-width: 900px; display: none; }
        
        /* LOGIN */
        #loginScreen { position: fixed; inset: 0; background: var(--bg); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
        .login-box { background: var(--card); padding: 40px; border-radius: 20px; border: 1px solid var(--cyan); text-align: center; width: 320px; }
        .login-box input { display: block; width: 100%; margin: 10px 0; padding: 12px; background: rgba(0,0,0,0.5); border: 1px solid #333; color: white; border-radius: 8px; box-sizing: border-box; outline: none;}

        /* STATS */
        .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .stat-card { background: rgba(255,255,255,0.02); padding: 12px; border-radius: 12px; border: 1px solid #222; text-align: center; }
        .stat-val { display: block; font-size: 1.2rem; font-weight: bold; color: var(--cyan); }
        .stat-label { font-size: 0.55rem; color: #555; text-transform: uppercase; }

        .balance-container { background: #111; height: 10px; border-radius: 5px; margin: 10px 0 20px; display: flex; overflow: hidden; border: 1px solid #222; }
        .balance-segment { height: 100%; transition: width 0.4s ease; }

        /* GRIDS */
        .section-header { font-size: 0.7rem; color: #555; text-transform: uppercase; margin: 25px 0 10px; border-bottom: 1px solid #222; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
        .card { background: var(--card); border: 1px solid rgba(255,255,255,0.05); border-radius: 15px; padding: 15px; text-align: center; transition: 0.3s; opacity: 0.4; filter: grayscale(1); position: relative; }
        .card.has-tokens { opacity: 1; filter: grayscale(0); border-color: var(--cyan); }
        
        .token-img { width: 50px; height: 50px; object-fit: contain; margin-bottom: 8px; transition: transform 0.3s; }
        .card:hover .token-img { transform: scale(1.15); filter: drop-shadow(0 0 8px var(--cyan)); }

        .comm-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px; }
        .comm-box { background: rgba(0,0,0,0.3); border: 1px solid #222; border-radius: 12px; height: 250px; display: flex; flex-direction: column; }
        .comm-content { flex: 1; overflow-y: auto; padding: 10px; font-size: 0.7rem; font-family: monospace; }
        
        /* BOTONES */
        .u-btn { background: #222; color: #777; border: 1px solid #333; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.65rem; }
        .u-btn:hover { color: #fff; border-color: var(--cyan); }
        .u-btn-mini { background: transparent; border: 1px solid var(--gold); color: var(--gold); padding: 2px 8px; border-radius: 4px; font-size: 0.6rem; cursor: pointer; }
        .btn-main { padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 0.75rem; width: 100%; }

        /* MODO COMPACTO - IMPLEMENTACI√ìN LIMPIA */
        body.compact .container { max-width: 450px; }
        body.compact .grid { grid-template-columns: repeat(3, 1fr); gap: 8px; }
        body.compact .card { padding: 8px; border-radius: 8px; }
        body.compact .token-img { width: 30px; height: 30px; margin-bottom: 4px; }
        body.compact .stat-val { font-size: 0.9rem; }
        body.compact .comm-grid { grid-template-columns: 1fr; }
        body.compact .stats-bar { gap: 5px; }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <h2 style="color:var(--cyan); margin-bottom: 5px;">MOONBOX NOTE</h2>
        <p style="font-size:0.6rem; color:#777; margin-bottom: 20px;">SISTEMA DE ENLACE COMPARTIDO POR LLAVE UNICA</p>
        <input type="text" id="userInput" placeholder="USUARIO">
        <input type="text" id="syncKey" placeholder="LLAVE DE RED">
        <button class="btn-main" style="background:var(--cyan); color:#000;" onclick="attemptLogin()">CONECTAR</button>
    </div>
</div>

<div class="container" id="mainApp">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
        <div style="font-size:0.7rem">
            <span id="syncDot" style="color:var(--green)">‚óè</span> <b id="displayKey" style="color:var(--gold)">-</b> | <b id="displayUser" style="color:var(--cyan)">-</b>
        </div>
        <div style="display:flex; gap:5px;">
            <button class="u-btn" onclick="toggleCompact()">üåì COMPACTO</button>
            <button class="u-btn" style="border-color:var(--danger); color:var(--danger)" onclick="location.reload()">CERRAR SESI√ìN</button>
        </div>
    </div>

    <div class="stats-bar">
        <div class="stat-card"><span class="stat-val" id="statCanClaim">0</span><span class="stat-label">Reclamables</span></div>
        <div class="stat-card"><span class="stat-val" id="statTotalTokens">0</span><span class="stat-label">Total Red</span></div>
        <div class="stat-card"><span class="stat-val" id="statEscaso" style="color:var(--gold)">-</span><span class="stat-label">Escaso</span></div>
    </div>
    
    <div id="balanceBar" class="balance-container"></div>

    <div class="section-header">
        Sesi√≥n Activa
        <div style="display:flex; gap:5px">
             <button class="u-btn-mini" onclick="setStyle('JAPONES')">Original</button>
			<button class="u-btn-mini" onclick="setStyle('TRADUCIDO')">Traducido</button>
            <button class="u-btn-mini" onclick="setStyle('TECLADO')">Teclado</button>
        </div>
    </div>
    <div id="sessionGrid" class="grid"></div>

    <div style="display:grid; grid-template-columns: 2fr 1fr; gap: 8px; margin: 15px 0;">
        <button class="btn-main" style="background:var(--green); color:#000" onclick="moveToVault()">SUBIR A INVENTARIO</button>
        <button class="btn-main" id="claimBtn" style="background:var(--purple); color:#fff" onclick="doClaim()">RECLAMAR (<span id="claimText">0</span>)</button>
    </div>

    <div class="section-header">
        <span>Inventario Compartido</span>
        <button class="u-btn-mini" onclick="withdrawAll()">RETIRAR TODO</button>
    </div>
    <div id="vaultGrid" class="grid" style="grid-template-columns: repeat(3, 1fr);"></div>

    <div class="comm-grid">
        <div class="comm-box">
            <div style="padding:6px; font-size:0.6rem; color:#555; border-bottom:1px solid #222; display:flex; justify-content:space-between">
                HISTORIAL <button class="u-btn-mini" style="color:var(--danger)" onclick="clearLogs()">LIMPIAR</button>
            </div>
            <div class="comm-content" id="logBox"></div>
        </div>
        <div class="comm-box">
            <div style="padding:6px; font-size:0.6rem; color:#555; border-bottom:1px solid #222">CHAT</div>
            <div class="comm-content" id="chatBox"></div>
            <div style="display:flex; padding:5px; border-top:1px solid #222">
                <input type="text" id="chatInput" placeholder="..." style="flex:1; background:transparent; border:none; color:white; outline:none; font-size:0.8rem" onkeypress="if(event.key==='Enter') sendChat()">
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDX9mBXhGSx6vVqvrLgMLY0Stno4nI-jPw",
        authDomain: "moonbox-b997c.firebaseapp.com",
        projectId: "moonbox-b997c",
        databaseURL: "https://moonbox-b997c-default-rtdb.firebaseio.com",
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    const TOKENS = ["CALMED", "DISTURBED", "PROSPEROUS", "DESERTED", "CHAOS", "PEACE"];
    const COLORS = ["#00e5ff", "#8a4fff", "#2ecc71", "#c5a059", "#ff4444", "#ffffff"];
    const STYLES = {
        TRADUCIDO: { CALMED: "calmed.png", DISTURBED: "disturbed.png", PROSPEROUS: "prosperous.png", DESERTED: "deserted.png", CHAOS: "chaos.png", PEACE: "peace.png" },
        JAPONES: { CALMED: "jp_calmed.png", DISTURBED: "jp_disturbed.png", PROSPEROUS: "jp_prosperous.png", DESERTED: "jp_deserted.png", CHAOS: "jp_chaos.png", PEACE: "jp_peace.png" },
        TECLADO: { CALMED: "kb_calmed.png", DISTURBED: "kb_disturbed.png", PROSPEROUS: "kb_prosperous.png", DESERTED: "kb_deserted.png", CHAOS: "kb_chaos.png", PEACE: "kb_peace.png" }
    };

    let currentUser = "", currentKey = "", currentStyle = "JAPONES";
    let db = { session:{}, vault:{}, chat:[], logs:[] };

    function attemptLogin() {
        const userIn = document.getElementById('userInput').value.trim().toUpperCase();
        const keyIn = document.getElementById('syncKey').value.trim().toUpperCase();
        if(!userIn || !keyIn) return;

        currentUser = userIn;
        currentKey = keyIn;

        // Primero escuchamos para no sobreescribir
        database.ref('keys/' + currentKey).on('value', (s) => {
            const data = s.val();
            if(data) {
                db = data;
                // Asegurar que existan los objetos internos
                if(!db.session) db.session = {};
                if(!db.vault) db.vault = {};
                if(!db.logs) db.logs = [];
                if(!db.chat) db.chat = [];
            } else {
                // Si la llave es nueva, inicializar objeto base
                db = { session:{}, vault:{}, chat:[], logs:[] };
            }
            render();
        });

        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('displayUser').innerText = currentUser;
        document.getElementById('displayKey').innerText = currentKey;
        
        // Log de entrada solo se dispara una vez al logear
        setTimeout(() => addLog("INGRES√ì"), 1000);
    }

    function render() {
        const s = db.session || {};
        const v = db.vault || {};

        let totalT = 0;
        let counts = TOKENS.map(t => v[t] || 0);
        counts.forEach(c => totalT += c);
        const canClaim = Math.min(...counts);
        const escasoIdx = counts.indexOf(Math.min(...counts));

        document.getElementById('statCanClaim').innerText = canClaim;
        document.getElementById('statTotalTokens').innerText = totalT;
        document.getElementById('statEscaso').innerText = totalT > 0 ? TOKENS[escasoIdx] : "-";

        document.getElementById('balanceBar').innerHTML = TOKENS.map((t, i) => {
            const pct = totalT > 0 ? ((v[t] || 0) / totalT) * 100 : 16.6;
            return `<div class="balance-segment" style="width:${pct}%; background:${COLORS[i]}"></div>`;
        }).join('');

        document.getElementById('sessionGrid').innerHTML = TOKENS.map(t => {
            const val = s[t] || 0;
            return `<div class="card ${val > 0 ? 'has-tokens' : ''}">
                <img src="${STYLES[currentStyle][t]}" class="token-img" onerror="this.src='https://via.placeholder.com/40?text=${t[0]}'">
                <div style="font-size:0.5rem; font-weight:bold">${t}</div>
                <div style="display:flex; justify-content:center; align-items:center; gap:8px; margin-top:5px">
                    <button class="u-btn" onclick="change('${t}',-1)">-</button>
                    <b>${val}</b>
                    <button class="u-btn" onclick="change('${t}',1)">+</button>
                </div>
            </div>`;
        }).join('');

        document.getElementById('vaultGrid').innerHTML = TOKENS.map(t => `
            <div class="card ${(v[t]||0) > 0 ? 'has-tokens' : ''}" style="padding:8px">
                <div style="font-size:1.1rem; color:var(--gold); font-weight:bold">${v[t]||0}</div>
                <div style="font-size:0.4rem">${t}</div>
                <button class="u-btn" style="width:100%; margin-top:5px; padding:2px" onclick="withdrawOne('${t}')">‚Üë</button>
            </div>`).join('');

        document.getElementById('logBox').innerHTML = (db.logs || []).map(l => `<div><span style="color:#555">[${l.d}]</span> <b style="color:var(--cyan)">${l.u}</b> ${l.m}</div>`).join('');
        document.getElementById('chatBox').innerHTML = (db.chat || []).map(m => `<div><b style="color:var(--cyan)">${m.u}:</b> ${m.t}</div>`).join('');
        document.getElementById('claimText').innerText = Math.min(...TOKENS.map(t => s[t] || 0));
    }

    function change(t, v) {
        if(!db.session) db.session = {};
        db.session[t] = Math.max(0, (db.session[t] || 0) + v);
        addLog(`${v > 0 ? '+1' : '-1'} ${t}`);
        save();
    }

    function moveToVault() {
        TOKENS.forEach(t => {
            if(db.session[t] > 0) {
                if(!db.vault) db.vault = {};
                db.vault[t] = (db.vault[t] || 0) + db.session[t];
                db.session[t] = 0;
            }
        });
        addLog("SUBI√ì INVENTARIO");
        save();
    }

    function withdrawOne(t) {
        if(db.vault[t] > 0) {
            db.vault[t]--;
            db.session[t] = (db.session[t] || 0) + 1;
            addLog(`RETIR√ì 1 ${t}`);
            save();
        }
    }

    function withdrawAll() {
        TOKENS.forEach(t => {
            db.session[t] = (db.session[t] || 0) + (db.vault[t] || 0);
            db.vault[t] = 0;
        });
        addLog("RETIR√ì TODO");
        save();
    }

    function doClaim() {
        TOKENS.forEach(t => db.session[t]--);
        addLog("!!! RECLAM√ì !!!");
        save();
    }

    function addLog(m) {
        if(!db.logs) db.logs = [];
        const now = new Date();
        const d = `${now.getDate()}/${now.getMonth()+1} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
        db.logs.unshift({ d, u: currentUser, m });
        if(db.logs.length > 40) db.logs.pop();
    }

    function clearLogs() { db.logs = []; save(); }
    function setStyle(s) { currentStyle = s; render(); }
    function toggleCompact() { document.body.classList.toggle('compact'); }
    function sendChat() {
        const i = document.getElementById('chatInput');
        if(!i.value.trim()) return;
        if(!db.chat) db.chat = [];
        db.chat.push({ u: currentUser, t: i.value });
        if(db.chat.length > 20) db.chat.shift();
        i.value = "";
        save();
    }
    function save() { 
        if(currentKey) database.ref('keys/' + currentKey).update(db); 
    }
</script>
</body>
</html>
