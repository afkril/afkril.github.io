<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Novedades | JER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { background-attachment: fixed; background-size: cover; background-position: center; transition: all 0.5s ease; font-family: 'Inter', sans-serif; }
        .glass-container { background: rgba(255, 255, 255, 0.96); backdrop-filter: blur(8px); }
        input, select { padding: 0.6rem 0.8rem !important; font-size: 0.9rem !important; border: 2px solid #e2e8f0 !important; outline: none !important; transition: all 0.2s; }
        input:focus, select:focus { border-color: #94a3b8 !important; box-shadow: 0 0 0 3px rgba(0,0,0,0.05); }
        .step-badge { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 50%; color: white; font-weight: bold; font-size: 0.8rem; }
        
        .contract-665 .dynamic-bg { background-color: #D97706; }
        .contract-665 .dynamic-text { color: #D97706; }
        .contract-665 .dynamic-border { border-top-color: #D97706; }
        
        .contract-667 .dynamic-bg { background-color: #2563EB; }
        .contract-667 .dynamic-text { color: #2563EB; }
        .contract-667 .dynamic-border { border-top-color: #2563EB; }
        
        .contract-676 .dynamic-bg { background-color: #059669; }
        .contract-676 .dynamic-text { color: #059669; }
        .contract-676 .dynamic-border { border-top-color: #059669; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 bg-slate-100">

    <main id="mainCard" class="glass-container w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden border-t-[12px] border-slate-300 dynamic-border animate__animated animate__fadeIn">
        
        <header class="px-6 py-4 bg-white border-b border-slate-100 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-800 text-slate-800 tracking-tight">Reporte de <span class="dynamic-text text-slate-500">Novedades</span></h1>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Asociación J.E.R - Neiva</p>
            </div>
            <div id="contractIndicator" class="px-3 py-1 rounded-full text-[10px] font-black text-white bg-slate-400 uppercase">Sin Contrato</div>
        </header>

        <form id="noveltyForm" action="https://formspree.io/f/mqardynz" method="POST" class="p-6 space-y-4">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="flex items-center text-xs font-bold text-slate-600 uppercase">
                        <span class="step-badge bg-slate-400 dynamic-bg mr-2">1</span> Contrato
                    </label>
                    <select id="contractNumber" name="Contrato" required class="w-full rounded-xl" onchange="updateStyles()">
                        <option value="">Seleccione...</option>
                        <option value="665">Contrato 665</option>
                        <option value="667">Contrato 667</option>
                        <option value="676">Contrato 676</option>
                    </select>
                </div>
                <div id="sectionUDS" class="space-y-1 opacity-50">
                    <label class="flex items-center text-xs font-bold text-slate-600 uppercase">
                        <span class="step-badge bg-slate-400 dynamic-bg mr-2">2</span> UDS
                    </label>
                    <select id="mainUdsDropdown" name="UDS_Full" required disabled class="w-full rounded-xl">
                        <option value="">-- Primero Contrato --</option>
                    </select>
                </div>
            </div>

            <div class="pt-2">
                <label class="flex items-center text-xs font-bold text-slate-600 uppercase mb-3">
                    <span class="step-badge bg-slate-400 dynamic-bg mr-2">3</span> ¿Qué reportará?
                </label>
                <div class="grid grid-cols-2 gap-3">
                    <label class="flex items-center p-3 rounded-xl border-2 border-slate-100 cursor-pointer hover:bg-slate-50 transition-all has-[:checked]:border-red-500 has-[:checked]:bg-red-50">
                        <input type="checkbox" id="checkRetiro" class="hidden" onchange="toggleSection('retiro')">
                        <span class="text-xs font-bold text-slate-600">RETIRO</span>
                    </label>
                    <label class="flex items-center p-3 rounded-xl border-2 border-slate-100 cursor-pointer hover:bg-slate-50 transition-all has-[:checked]:border-green-500 has-[:checked]:bg-green-50">
                        <input type="checkbox" id="checkIngreso" class="hidden" onchange="toggleSection('ingreso')">
                        <span class="text-xs font-bold text-slate-600">INGRESO</span>
                    </label>
                </div>
            </div>

            <div id="sectionRetiro" class="hidden animate__animated animate__fadeIn p-4 rounded-2xl bg-red-50/50 border border-red-100 space-y-3">
                <h3 class="text-xs font-black text-red-700 uppercase tracking-tighter flex items-center">
                    <span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span> Beneficiario Saliente
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <input type="text" id="retiroDocNumber" placeholder="Número de Documento" class="w-full rounded-lg">
                    <input type="text" id="retiroFullName" placeholder="Nombre Completo" class="w-full rounded-lg">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-red-600 ml-1 uppercase">Fecha de Retiro</label>
                        <input type="date" id="retiroDate" class="w-full rounded-lg">
                    </div>
                    <div class="flex items-center justify-center space-x-4 bg-white px-3 py-1 rounded-lg border border-red-100">
                        <span class="text-[10px] font-bold text-slate-400">GÉNERO:</span>
                        <label class="text-xs font-bold"><input type="radio" name="retiroGender" value="M"> M</label>
                        <label class="text-xs font-bold"><input type="radio" name="retiroGender" value="F"> F</label>
                    </div>
                </div>
            </div>

            <div id="sectionIngreso" class="hidden animate__animated animate__fadeIn space-y-4">
                <div class="p-4 rounded-2xl bg-green-50/50 border border-green-100 space-y-3">
                    <h3 class="text-xs font-black text-green-700 uppercase tracking-tighter flex items-center">
                        <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span> Beneficiario Entrante
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <input type="text" id="ingresoDocNumber" placeholder="Documento Niño" class="w-full rounded-lg">
                        <input type="text" id="ingresoFullName" placeholder="Nombre Niño" class="w-full rounded-lg">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-green-600 ml-1 uppercase">Fecha de Nacimiento</label>
                            <input type="date" id="ingresoDOB" class="w-full rounded-lg" onchange="calculateAge()">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-green-600 ml-1 uppercase">Fecha de Ingreso</label>
                            <input type="date" id="ingresoDate" class="w-full rounded-lg" onchange="calculateAge()">
                        </div>
						<div class="flex items-center justify-center space-x-4 bg-white px-3 py-1 rounded-lg border border-red-100">
							<span class="text-[10px] font-bold text-slate-400">GÉNERO:</span>
							<label class="text-xs font-bold"><input type="radio" name="IngresoGender" value="M"> M</label>
							<label class="text-xs font-bold"><input type="radio" name="IngresoGender" value="F"> F</label>
						</div>
                        <input type="text" id="ingresoAddress" placeholder="Dirección" class="w-full rounded-lg">
                        <input type="tel" id="ingresoPhone" placeholder="Teléfono" class="w-full rounded-lg">
                    </div>
                </div>
                <div class="p-4 rounded-2xl bg-blue-50/50 border border-blue-100 space-y-3">
                    <h3 class="text-xs font-black text-blue-700 uppercase tracking-tighter flex items-center">
                        <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span> Datos Madre / Acudiente
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <input type="text" id="acudienteDoc" placeholder="Documento Acudiente" class="w-full rounded-lg">
                        <input type="text" id="acudienteName" placeholder="Nombre Acudiente" class="w-full rounded-lg">
                        <div class="space-y-1 md:col-span-2">
                            <label class="text-[10px] font-bold text-blue-600 ml-1 uppercase">Fecha Nacimiento Acudiente</label>
                            <input type="date" id="acudienteDOB" class="w-full rounded-lg">
                        </div>
                    </div>
                </div>
            </div>

            <input type="hidden" name="REPORTE_DETALLADO" id="hiddenFormattedData">
			<input type="hidden" name="_subject" id="emailSubject" value="Novedad UDS">
            <button type="submit" id="submitButton" class="dynamic-bg bg-slate-400 w-full py-3.5 rounded-2xl text-white font-black text-sm tracking-widest shadow-lg hover:brightness-110 active:scale-[0.98] transition-all uppercase">
                Enviar Reporte Al Correo
            </button>
            
            <div id="feedbackContainer" class="hidden animate__animated p-4 rounded-2xl text-center text-xs font-bold mt-4"></div>
        </form>
    </main>

    <script>
        // Mismos datos UDS y BACKGROUNDS anteriores...
        const UDS_DATA = { '665': [['ALEGRIA DE VIVIR.', '4100100115777'], ['LOS CARIÑOSITOS', '4100100043894'], ['LOS DUMIS.', '4100100115770'], ['LOS JUGUETONES.', '4100100115796'], ['LOS ANGELITOS', '4100100041381'], ['LOS CHUPETINES', '4100100038177'], ['LOS PINGUINOS', '4100100041027'], ['MAFALDA', '4100100115757'], ['MIS AMIGUITOS.', '4100100115793'], ['MIS ANGELITOS.', '4100100115781'], ['MIS ANGELITOS', '410011123928'], ['MIS CAPULLOS', '4100100040968'], ['MIS 15 ANGELITOS', '4100100041374'], ['MIS PEQUEÑOS GIGANTES', '4100100040991'], ['MIS PEQUEÑOS PUPILOS', '4100100115788'], ['MIS PEQUEÑOS SALTARINES', '4100100041008'], ['MIS PEQUEÑOS SALTARINES', '4100100047851'], ['NIÑOS FELICES', '4100100041394'], ['PLUTO.', '4100100115774']], '667': [['BLANCA NIEVES', '4100100078903'], ['CHIQUILLADAS', '4100100120110'], ['DIAS FELICES', '4100100023616'], ['LA RANA RENE', '4100100120291'], ['LOS PITUFOS', '4100100127770'], ['MIS CHIQUITINES', '4100100024111'], ['LOS CHIQUITINES', '4100100112390'], ['LOS EXPLORADORES', '4100100023662'], ['MI MUNDO FELIZ', '4100100023780'], ['MI PEQUEÑO MUNDO', '4100100023816'], ['MIS PEQUEÑOS ANGELITOS', '4100100029904'], ['MIS PASTORCITOS', '4100100023682'], ['MIS PATICOS', '4100100023459'], ['MIS PICARDIAS', '4100100044836'], ['MIS PIRUETAS', '4100100128106'], ['MI PRIMER PASO', '4100100045206'], ['PEQUEÑOS GIGANTES', '4100100120109'], ['SEMILLITAS', '4100100024235']], '676': [['ALEGRIA', '4100100085789'], ['BAMBY', '4100100091036'], ['BAMBIS 2', '4100100083331'], ['BURBUJITAS', '4100100043041'], ['CASITA ENCANTADA', '4100100085784'], ['HOGAR FELIZ', '4100100085820'], ['POLLITOS', '4100100085805'], ['PICAPIEDRAS', '4100100043022'], ['SABIDURIA', '4100100085779'], ['LA PEQUEÑA LULU', '4100100085809'], ['LOS ANGELITOS', '4100100043056'], ['LOS CARIÑOSITOS', '4100100091312'], ['LOS SIMPSONS', '4100100041466'], ['LOS CHIQUILLOS', '4100100085803'], ['MI PEQUEÑA CASITA', '4100100085800'], ['MIS AMIGUITOS', '4100100043065'], ['MIS CORAZONSITOS', '4100100024142'], ['MIS OSITOS', '4100100107660'], ['MIS PEQUEÑOS ANGELITOS', '4100100115738']] };
        const BACKGROUNDS = { '665': 'linear-gradient(to bottom right, #fef3c7, #fbbf24)', '667': 'linear-gradient(to bottom right, #dbeafe, #3b82f6)', '676': 'linear-gradient(to bottom right, #d1fae5, #10b981)', 'default': 'linear-gradient(to bottom right, #f8fafc, #e2e8f0)' };

        function updateStyles() {
            const contract = document.getElementById('contractNumber').value;
            const mainCard = document.getElementById('mainCard');
            const indicator = document.getElementById('contractIndicator');
            const udsSelect = document.getElementById('mainUdsDropdown');
            const sectionUDS = document.getElementById('sectionUDS');
            mainCard.className = "glass-container w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden border-t-[12px] dynamic-border animate__animated animate__fadeIn";
            document.body.style.background = BACKGROUNDS[contract] || BACKGROUNDS['default'];
            if (contract) {
                mainCard.classList.add(`contract-${contract}`);
                indicator.className = `px-3 py-1 rounded-full text-[10px] font-black text-white dynamic-bg uppercase`;
                indicator.textContent = `Contrato ${contract}`;
                udsSelect.disabled = false;
                sectionUDS.style.opacity = "1";
                populateUDS(contract);
            } else {
                indicator.className = "px-3 py-1 rounded-full text-[10px] font-black text-white bg-slate-400 uppercase";
                indicator.textContent = "Sin Contrato";
                udsSelect.disabled = true;
                udsSelect.innerHTML = '<option value="">-- Primero Contrato --</option>';
                sectionUDS.style.opacity = "0.5";
            }
        }

        function populateUDS(contract) {
            const udsSelect = document.getElementById('mainUdsDropdown');
            udsSelect.innerHTML = '<option value="">-- Seleccione UDS --</option>';
            UDS_DATA[contract]?.forEach(([name, code]) => {
                const opt = document.createElement('option');
                opt.value = `${name} - ${code}`;
                opt.textContent = `${name} - ${code}`;
                udsSelect.appendChild(opt);
            });
        }

        function toggleSection(type) {
            const section = document.getElementById(type === 'retiro' ? 'sectionRetiro' : 'sectionIngreso');
            const check = document.getElementById(type === 'retiro' ? 'checkRetiro' : 'checkIngreso');
            section.classList.toggle('hidden', !check.checked);
        }

        function calculateAge() {
            const dob = document.getElementById('ingresoDOB').value;
            const entry = document.getElementById('ingresoDate').value;
            if (dob && entry) {
                const d1 = new Date(dob);
                const d2 = new Date(entry);
                let years = d2.getFullYear() - d1.getFullYear();
                let months = d2.getMonth() - d1.getMonth();
                if (months < 0) { years--; months += 12; }
                return `${years} años y ${months} meses`;
            }
            return '--';
        }

        function showFeedback(message, type) {
            const container = document.getElementById('feedbackContainer');
            container.textContent = message;
            container.className = `p-4 rounded-2xl text-center text-xs font-bold animate__animated animate__fadeInUp mt-4 `;
            if (type === 'success') container.classList.add('bg-green-100', 'text-green-700', 'border', 'border-green-200');
            else container.classList.add('bg-red-100', 'text-red-700', 'border', 'border-red-200', 'animate__shakeX');
            container.classList.remove('hidden');
        }

        // --- FUNCIÓN DE FORMATEO SOLICITADA ---
        function formatData() {
            const contractNumber = document.getElementById('contractNumber').value;
            const udsSelection = document.getElementById('mainUdsDropdown').value;
            const utsName = udsSelection.split(' - ')[0] || 'No Seleccionado';
            const utsCode = udsSelection.split(' - ')[1] || 'No Seleccionado';
            
            let formData = `**NOVEDAD DE BENEFICIARIOS UDS**\n`;
            formData += `==================================\n`;
            formData += `CONTRATO: ${contractNumber}\n`;
            formData += `UDS (NOMBRE): ${utsName}\n`;
            formData += `UDS (CÓDIGO): ${utsCode}\n`;
            formData += `==================================\n\n`;

            if (document.getElementById('checkRetiro').checked) {
                formData += `--- DATOS DE RETIRO ---\n`;
                formData += `Documento: ${document.getElementById('retiroDocNumber').value}\n`;
                formData += `Nombre: ${document.getElementById('retiroFullName').value}\n`;
                formData += `Fecha Retiro: ${document.getElementById('retiroDate').value}\n`;
                formData += `Género: ${document.querySelector('input[name="retiroGender"]:checked')?.value || 'N/A'}\n\n`;
            }

            if (document.getElementById('checkIngreso').checked) {
                formData += `--- DATOS DE INGRESO ---\n`;
                formData += `Niño: ${document.getElementById('ingresoFullName').value}\n`;
                formData += `Documento: ${document.getElementById('ingresoDocNumber').value}\n`;
                formData += `Edad: ${calculateAge()}\n`;
				formData += `Fecha Nacimiento: ${document.getElementById('ingresoDOB').value}\n`;
                formData += `Fecha Ingreso: ${document.getElementById('ingresoDate').value}\n`;
				formData += `Género: ${document.querySelector('input[name="IngresoGender"]:checked')?.value || 'N/A'}\n\n`;
                formData += `Dirección: ${document.getElementById('ingresoAddress').value}\n`;
				formData += `--- DATOS DE ACUDIENTE ---\n`;
                formData += `Acudiente: ${document.getElementById('acudienteName').value}\n`;
                formData += `Doc. Acudiente: ${document.getElementById('acudienteDoc').value}\n`;
				formData += `F.N. Acudiente: ${document.getElementById('acudienteDOB').value}\n`;
            }
            return formData;
        }

        // --- ENVÍO ---
		document.getElementById('noveltyForm').addEventListener('submit', async function(e) {
			e.preventDefault();
			const btn = document.getElementById('submitButton');
			
			// 1. Obtener nombre de la UDS para el asunto
			const udsSelection = document.getElementById('mainUdsDropdown').value;
			const utsName = udsSelection.split(' - ')[0] || 'Desconocida';
			
			// 2. Actualizar el Asunto dinámico antes de enviar
			document.getElementById('emailSubject').value = `Novedad UDS: ${utsName}`;

			// 3. Validaciones de fechas (Retiro < Ingreso)
			if (document.getElementById('checkRetiro').checked && document.getElementById('checkIngreso').checked) {
				const fR = new Date(document.getElementById('retiroDate').value);
				const fI = new Date(document.getElementById('ingresoDate').value);
				if (fR >= fI) {
					showFeedback("❌ La fecha de retiro debe ser anterior a la de ingreso.", "error");
					return;
				}
			}

			// 4. Inyectar formato en campo oculto de cuerpo del mensaje
			document.getElementById('hiddenFormattedData').value = formatData();

			btn.disabled = true;
			btn.textContent = "ENVIANDO...";

			try {
				const response = await fetch(this.action, {
					method: 'POST',
					body: new FormData(this),
					headers: { 'Accept': 'application/json' }
				});
				if (response.ok) {
					showFeedback('✅ ¡Éxito! La novedad ha sido enviada correctamente al correo.', 'success');
					this.reset();
					updateStyles();
					document.getElementById('sectionRetiro').classList.add('hidden');
					document.getElementById('sectionIngreso').classList.add('hidden');
				} else {
					showFeedback("❌ Error en el servidor.", "error");
				}
			} catch {
				showFeedback("❌ Error de conexión.", "error");
			} finally {
				btn.disabled = false;
				btn.textContent = "ENVIAR REPORTE";
			}
		});
    </script>
</body>
</html>

