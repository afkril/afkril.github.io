<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Novedades de Beneficiarios UDS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Colores de base
                        'primary': '#059669', // Emerald 600
                        'secondary': '#1F2937', // Gray 800
                        'accent': '#3B82F6', // Blue 500

                        // Nuevos colores para Contratos (Amarillo, Azul, Verde)
                        'c665-primary': '#F59E0B', // Amber 500 (Amarillo)
                        'c665-shadow': '#FDE68A', // Amber 200
                        'c667-primary': '#3B82F6', // Blue 500 (Azul)
                        'c667-shadow': '#BFDBFE', // Blue 200
                        'c676-primary': '#10B981', // Emerald 500 (Verde)
                        'c676-shadow': '#A7F3D0', // Emerald 200
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');

        /* Clase base para el fondo del cuerpo (mezcla Negro y Azul) */
        .bg-black-blue {
            background-color: #0F172A; /* Slate 900 (Negro azulado) */
        }
        
        /* Estilos específicos para el hover y el foco del botón */
        .btn-hover-primary {
            transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform;
            transition-duration: 300ms;
        }

        /* Clases de utilidad para el botón y el marco del formulario */
        .contract-border-665 { border-top-color: #F59E0B; }
        .contract-shadow-665:hover { box-shadow: 0 25px 50px -12px rgba(245, 158, 11, 0.4); }
        .contract-bg-665 { background-color: #F59E0B; }
        .contract-bg-hover-665:hover { background-color: #D97706; }
        .contract-ring-665:focus { ring-color: #F59E0B; }
        
        .contract-border-667 { border-top-color: #3B82F6; }
        .contract-shadow-667:hover { box-shadow: 0 25px 50px -12px rgba(59, 130, 246, 0.4); }
        .contract-bg-667 { background-color: #3B82F6; }
        .contract-bg-hover-667:hover { background-color: #2563EB; }
        .contract-ring-667:focus { ring-color: #3B82F6; }
        
        .contract-border-676 { border-top-color: #10B981; }
        .contract-shadow-676:hover { box-shadow: 0 25px 50px -12px rgba(16, 185, 129, 0.4); }
        .contract-bg-676 { background-color: #10B981; }
        .contract-bg-hover-676:hover { background-color: #059669; }
        .contract-ring-676:focus { ring-color: #10B981; }
    </style>
</head>
<body class="bg-black-blue font-sans min-h-screen p-4 sm:p-8 transition-colors duration-500">

    <div id="formContainer" class="max-w-4xl mx-auto bg-white shadow-2xl rounded-3xl p-6 sm:p-10 border-t-8 border-primary transform hover:shadow-primary/30 transition duration-300">
        <header class="mb-10 text-center">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-secondary mb-3">
                Registro de Novedades <span class="text-primary">UDS</span>
            </h1>
            <p class="text-gray-600 font-medium">Diligencie la información requerida para el contrato y el tipo de novedad.</p>
        </header>

        <form id="noveltyForm" class="space-y-8">

            <div class="p-6 bg-indigo-50 rounded-xl border border-indigo-300 shadow-md">
                <h2 class="text-xl font-bold text-indigo-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0v-2a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    Selección de Contrato
                </h2>
                <div>
                    <label for="contractNumber" class="block text-sm font-medium text-gray-700">NÚMERO DE CONTRATO *</label>
                    <select id="contractNumber" name="contractNumber" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-accent focus:ring-accent p-3 bg-white transition duration-150" onchange="updateFormStyle()">
                        <option value="">-- Seleccione un Contrato --</option>
                        <option value="665">665</option>
                        <option value="667">667</option>
                        <option value="676">676</option>
                    </select>
                </div>
            </div>

            <div class="p-6 bg-blue-50 rounded-xl border border-blue-300 shadow-md">
                <h2 class="text-xl font-bold text-blue-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.242a2.24 2.24 0 01.32-.444L14.457 3.32a2.24 2.24 0 01-.444-.32m.618 17.242A2.24 2.24 0 0119 19.998v-4.502a2.24 2.24 0 01-2-2v-4.502a2.24 2.24 0 01-2-2v-2a2 2 0 00-2-2H9a2 2 0 00-2 2v2a2 2 0 01-2 2v4.502a2.24 2.24 0 01-2 2v4.502c.004.887.68 1.602 1.554 1.748l.05.002h13.796l.05-.002a2.24 2.24 0 011.554-1.748z"></path></svg>
                    Tipo de Novedad
                </h2>
                <div class="flex flex-col sm:flex-row gap-6">
                    <label class="flex items-center cursor-pointer p-2 bg-white rounded-lg shadow-sm hover:bg-red-50 transition duration-150 border border-transparent has-[:checked]:border-red-400">
                        <input type="checkbox" id="checkRetiro" class="h-5 w-5 text-red-600 rounded focus:ring-red-500" onchange="toggleSection('retiro')">
                        <span class="ml-3 text-gray-700 font-medium">Novedad de <span class="font-bold text-red-700">Retiro (Sale)</span></span>
                    </label>
                    <label class="flex items-center cursor-pointer p-2 bg-white rounded-lg shadow-sm hover:bg-green-50 transition duration-150 border border-transparent has-[:checked]:border-green-400">
                        <input type="checkbox" id="checkIngreso" class="h-5 w-5 text-green-600 rounded focus:ring-green-500" onchange="toggleSection('ingreso')">
                        <span class="ml-3 text-gray-700 font-medium">Novedad de <span class="font-bold text-green-700">Ingreso (Entra)</span></span>
                    </label>
                </div>
            </div>

            <div id="sectionRetiro" class="hidden p-6 bg-red-50 rounded-xl border border-red-300 transition-all duration-300 shadow-lg">
                <h2 class="text-2xl font-bold text-red-800 mb-6 border-b pb-2 border-red-300">Datos del Beneficiario que se Retira</h2>
                <div class="grid sm:grid-cols-2 gap-6">
                    <div><label for="retiroUdsName" class="block text-sm font-medium text-gray-700">NOMBRE UDS *</label><input type="text" id="retiroUdsName" name="retiroUdsName" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-3"></div>
                    <div><label for="retiroUdsCode" class="block text-sm font-medium text-gray-700">CODIGO UDS *</label><input type="text" id="retiroUdsCode" name="retiroUdsCode" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-3"></div>
                    <div><label for="retiroDocNumber" class="block text-sm font-medium text-gray-700">NÚMERO DOCUMENTO *</label><input type="text" id="retiroDocNumber" name="retiroDocNumber" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-3"></div>
                    <div><label for="retiroFullName" class="block text-sm font-medium text-gray-700">NOMBRES Y APELLIDOS *</label><input type="text" id="retiroFullName" name="retiroFullName" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-3"></div>
                    <div class="sm:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">GÉNERO *</label>
                        <div class="flex space-x-4" id="retiroGenderGroup">
                            <label class="inline-flex items-center"><input type="radio" name="retiroGender" value="Masculino" class="form-radio text-red-600 focus:ring-red-500"><span class="ml-2 text-gray-700">Masculino</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="retiroGender" value="Femenino" class="form-radio text-red-600 focus:ring-red-500"><span class="ml-2 text-gray-700">Femenino</span></label>
                        </div>
                    </div>
                    <div><label for="retiroDOB" class="block text-sm font-medium text-gray-700">FECHA NACIMIENTO *</label><input type="date" id="retiroDOB" name="retiroDOB" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-3"></div>
                    <div><label for="retiroDate" class="block text-sm font-medium text-gray-700">FECHA DE RETIRO *</label><input type="date" id="retiroDate" name="retiroDate" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-3"></div>
                </div>
            </div>

            <div id="sectionIngreso" class="hidden p-6 bg-green-50 rounded-xl border border-green-300 transition-all duration-300 shadow-lg">
                <h2 class="text-2xl font-bold text-green-800 mb-6 border-b pb-2 border-green-300">Datos del Beneficiario que Ingresa</h2>
                <div class="grid sm:grid-cols-2 gap-6">
                    <div><label for="ingresoUdsName" class="block text-sm font-medium text-gray-700">NOMBRE UDS *</label><input type="text" id="ingresoUdsName" name="ingresoUdsName" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-3"></div>
                    <div><label for="ingresoUdsCode" class="block text-sm font-medium text-gray-700">CODIGO UDS *</label><input type="text" id="ingresoUdsCode" name="ingresoUdsCode" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-3"></div>
                    <div><label for="ingresoDocNumber" class="block text-sm font-medium text-gray-700">NÚMERO DOCUMENTO *</label><input type="text" id="ingresoDocNumber" name="ingresoDocNumber" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-3"></div>
                    <div><label for="ingresoFullName" class="block text-sm font-medium text-gray-700">NOMBRES Y APELLIDOS *</label><input type="text" id="ingresoFullName" name="ingresoFullName" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-3"></div>
                    <div class="sm:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">GÉNERO *</label>
                        <div class="flex space-x-4" id="ingresoGenderGroup">
                            <label class="inline-flex items-center"><input type="radio" name="ingresoGender" value="Masculino" class="form-radio text-green-600 focus:ring-green-500"><span class="ml-2 text-gray-700">Masculino</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="ingresoGender" value="Femenino" class="form-radio text-green-600 focus:ring-green-500"><span class="ml-2 text-gray-700">Femenino</span></label>
                        </div>
                    </div>
                    <div><label for="ingresoDOB" class="block text-sm font-medium text-gray-700">FECHA NACIMIENTO *</label><input type="date" id="ingresoDOB" name="ingresoDOB" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-3"></div>
                    <div><label for="ingresoAddress" class="block text-sm font-medium text-gray-700">DIRECCIÓN *</label><input type="text" id="ingresoAddress" name="ingresoAddress" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-3"></div>
                    <div><label for="ingresoBarrio" class="block text-sm font-medium text-gray-700">BARRIO *</label><input type="text" id="ingresoBarrio" name="ingresoBarrio" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-3"></div>
                    <div><label for="ingresoPhone" class="block text-sm font-medium text-gray-700">TELÉFONO *</label><input type="tel" id="ingresoPhone" name="ingresoPhone" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-3"></div>

                    <div class="sm:col-span-2 mt-4 pt-4 border-t border-green-300">
                        <h3 class="text-lg font-bold text-green-700 mb-4">Datos de la Madre</h3>
                        <div class="grid sm:grid-cols-3 gap-6">
                            <div><label for="motherId" class="block text-sm font-medium text-gray-700">CÉDULA DE LA MADRE *</label><input type="text" id="motherId" name="motherId" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-3"></div>
                            <div class="sm:col-span-2"><label for="motherFullName" class="block text-sm font-medium text-gray-700">NOMBRES Y APELLIDOS *</label><input type="text" id="motherFullName" name="motherFullName" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-3"></div>
                            <div><label for="motherDOB" class="block text-sm font-medium text-gray-700">FECHA NACIMIENTO *</label><input type="date" id="motherDOB" name="motherDOB" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-3"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pt-8">
                <button type="submit" id="submitButton" class="w-full px-6 py-3 text-white font-extrabold rounded-xl shadow-lg btn-hover-primary transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-opacity-70 flex items-center justify-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                    <span id="buttonText">Enviar Novedad por API</span>
                </button>
            </div>
        </form>

        <div id="validationMessage" class="hidden mt-6 p-4 text-center rounded-lg shadow-md font-medium" role="alert">
            </div>
    </div>
    
    <script>
        // --- CONSTANTES ---
        const RECIPIENT_EMAIL = 'cuentamejoseeustaciorivera@gmail.com';
        const FORMSPREE_ENDPOINT = 'https://formspree.io/f/movbkavk';
        
        // --- ELEMENTOS DEL DOM ---
        const body = document.body;
        const formContainer = document.getElementById('formContainer');
        const form = document.getElementById('noveltyForm');
        const checkRetiro = document.getElementById('checkRetiro');
        const checkIngreso = document.getElementById('checkIngreso');
        const sectionRetiro = document.getElementById('sectionRetiro');
        const sectionIngreso = document.getElementById('sectionIngreso');
        const validationMessage = document.getElementById('validationMessage');
        const contractNumberSelect = document.getElementById('contractNumber');
        const submitButton = document.getElementById('submitButton');
        const buttonText = document.getElementById('buttonText');

        // Clases de Tailwind que se deben gestionar dinámicamente
        const colorClasses = ['contract-border-665', 'contract-shadow-665', 'contract-bg-665', 'contract-bg-hover-665', 'contract-ring-665', 
                              'contract-border-667', 'contract-shadow-667', 'contract-bg-667', 'contract-bg-hover-667', 'contract-ring-667', 
                              'contract-border-676', 'contract-shadow-676', 'contract-bg-676', 'contract-bg-hover-676', 'contract-ring-676', 
                              'border-primary', 'hover:shadow-primary/30', 'bg-primary', 'hover:bg-emerald-700', 'focus:ring-primary', 'bg-black-blue', 'bg-gray-100'];

        /**
         * Alterna la visibilidad de las secciones del formulario.
         * @param {string} sectionName - 'retiro' o 'ingreso'
         */
        function toggleSection(sectionName) {
            if (sectionName === 'retiro') {
                sectionRetiro.classList.toggle('hidden', !checkRetiro.checked);
            } else if (sectionName === 'ingreso') {
                sectionIngreso.classList.toggle('hidden', !checkIngreso.checked);
            }
        }
        
        /**
         * Cambia el color del contenedor y del botón basado en el contrato seleccionado.
         */
        function updateFormStyle() {
            const contractNumber = contractNumberSelect.value;
            
            // Limpiar clases anteriores del BODY
            body.classList.remove(...colorClasses);
            body.classList.add('bg-gray-100'); // Fondo por defecto de Tailwind
            
            // Limpiar clases anteriores del Contenedor y Botón
            formContainer.classList.remove(...colorClasses);
            submitButton.classList.remove(...colorClasses);

            if (contractNumber === '665') {
                // Fondo: Amarillo (escala de amarillo)
                body.classList.remove('bg-gray-100');
                body.classList.add('bg-amber-100'); // Puedes cambiar esto a un color más específico si es necesario
                
                // Contenedor y Botón: Amarillo
                formContainer.classList.add('contract-border-665', 'contract-shadow-665');
                submitButton.classList.add('contract-bg-665', 'contract-bg-hover-665', 'contract-ring-665');

            } else if (contractNumber === '667') {
                // Fondo: Azul (escala de azul)
                body.classList.remove('bg-gray-100');
                body.classList.add('bg-blue-100'); 
                
                // Contenedor y Botón: Azul
                formContainer.classList.add('contract-border-667', 'contract-shadow-667');
                submitButton.classList.add('contract-bg-667', 'contract-bg-hover-667', 'contract-ring-667');

            } else if (contractNumber === '676') {
                // Fondo: Verde (escala de verde)
                body.classList.remove('bg-gray-100');
                body.classList.add('bg-green-100'); 
                
                // Contenedor y Botón: Verde
                formContainer.classList.add('contract-border-676', 'contract-shadow-676');
                submitButton.classList.add('contract-bg-676', 'contract-bg-hover-676', 'contract-ring-676');
            } else {
                // Estado inicial (Fondo negro-azul y estilo primario por defecto)
                 body.classList.add('bg-black-blue');
                 formContainer.classList.add('border-primary', 'hover:shadow-primary/30');
                 submitButton.classList.add('bg-primary', 'hover:bg-emerald-700', 'focus:ring-primary');
            }
        }
        
        /**
         * Muestra un mensaje de feedback en el div de validación.
         * @param {string} message - El mensaje a mostrar.
         * @param {string} type - 'success', 'error', o 'info'
         */
        function showFeedback(message, type) {
            validationMessage.textContent = message;
            validationMessage.classList.remove('hidden', 'bg-yellow-100', 'text-yellow-800', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
            
            if (type === 'error') {
                validationMessage.classList.add('bg-red-100', 'text-red-800');
            } else if (type === 'success') {
                validationMessage.classList.add('bg-green-100', 'text-green-800');
            } else {
                 validationMessage.classList.add('bg-yellow-100', 'text-yellow-800');
            }
        }
        
        /**
         * Valida *todos* los campos requeridos de una sección visible.
         * @param {string} prefix - 'retiro' o 'ingreso'
         * @param {string} sectionName - Nombre legible de la sección
         * @returns {boolean} - true si es válido, false si no lo es
         */
        function validateSection(prefix, sectionName) {
            let isValid = true;
            let requiredFields = [];
            
            if (prefix === 'retiro') {
                if (!checkRetiro.checked) return true;

                requiredFields = [
                    'retiroUdsName', 'retiroUdsCode', 'retiroDocNumber', 'retiroFullName', 'retiroDOB', 'retiroDate'
                ];
                
                // Validación de Radio Button de Género de Retiro
                if (!document.querySelector('input[name="retiroGender"]:checked')) {
                     showFeedback(`ERROR: Debe seleccionar el Género del Beneficiario en la sección de ${sectionName} (*).`, 'error');
                     return false;
                }
            } else if (prefix === 'ingreso') {
                if (!checkIngreso.checked) return true;

                requiredFields = [
                    'ingresoUdsName', 'ingresoUdsCode', 'ingresoDocNumber', 'ingresoFullName', 
                    'ingresoDOB', 'ingresoAddress', 'ingresoBarrio', 'ingresoPhone', 
                    'motherId', 'motherFullName', 'motherDOB'
                ];
                
                // Validación de Radio Button de Género de Ingreso
                if (!document.querySelector('input[name="ingresoGender"]:checked')) {
                     showFeedback(`ERROR: Debe seleccionar el Género del Beneficiario en la sección de ${sectionName} (*).`, 'error');
                     return false;
                }
            }

            // Recorrido de campos requeridos y resaltado
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (field && !field.value.trim()) {
                    field.classList.add('border-red-500', 'ring-1', 'ring-red-500'); 
                    isValid = false;
                } else if (field) {
                    field.classList.remove('border-red-500', 'ring-1', 'ring-red-500');
                }
            }

            if (!isValid) {
                showFeedback(`ERROR: Por favor, complete *todos* los campos obligatorios (*) en la sección de ${sectionName}.`, 'error');
            }
            
            return isValid;
        }

        /**
         * Recolecta los datos del formulario en un formato estructurado (texto).
         */
        function getSectionData(prefix, sectionTitle) {
            let data = `\n--- ${sectionTitle} ---\n`;
            
            if (prefix === 'retiro') {
                data += `NOMBRE UDS: ${document.getElementById('retiroUdsName').value || 'N/A'}\n`;
                data += `CODIGO UDS: ${document.getElementById('retiroUdsCode').value || 'N/A'}\n`;
                data += `NUMERO DOCUMENTO: ${document.getElementById('retiroDocNumber').value || 'N/A'}\n`;
                data += `NOMBRES Y APELLIDOS: ${document.getElementById('retiroFullName').value || 'N/A'}\n`;
                data += `GENERO: ${document.querySelector('input[name="retiroGender"]:checked')?.value || 'N/A'}\n`;
                data += `FECHA NACIMIENTO: ${document.getElementById('retiroDOB').value || 'N/A'}\n`;
                data += `FECHA DE RETIRO: ${document.getElementById('retiroDate').value || 'N/A'}\n`;
            } else if (prefix === 'ingreso') {
                data += `\nDATOS DEL BENEFICIARIO DE INGRESO:\n`;
                data += `NOMBRE UDS: ${document.getElementById('ingresoUdsName').value || 'N/A'}\n`;
                data += `CODIGO UDS: ${document.getElementById('ingresoUdsCode').value || 'N/A'}\n`;
                data += `NUMERO DOCUMENTO: ${document.getElementById('ingresoDocNumber').value || 'N/A'}\n`;
                data += `NOMBRES Y APELLIDOS: ${document.getElementById('ingresoFullName').value || 'N/A'}\n`;
                data += `GENERO: ${document.querySelector('input[name="ingresoGender"]:checked')?.value || 'N/A'}\n`;
                data += `FECHA NACIMIENTO: ${document.getElementById('ingresoDOB').value || 'N/A'}\n`;
                data += `DIRECCIÓN: ${document.getElementById('ingresoAddress').value || 'N/A'}\n`;
                data += `BARRIO: ${document.getElementById('ingresoBarrio').value || 'N/A'}\n`;
                data += `TELÉFONO: ${document.getElementById('ingresoPhone').value || 'N/A'}\n`;

                data += `\nDATOS DE LA MADRE:\n`;
                data += `CEDULA DE LA MADRE: ${document.getElementById('motherId').value || 'N/A'}\n`;
                data += `NOMBRES Y APELLIDOS: ${document.getElementById('motherFullName').value || 'N/A'}\n`;
                data += `FECHA NACIMIENTO: ${document.getElementById('motherDOB').value || 'N/A'}\n`;
            }
            
            return data;
        }

        // Listener para la sumisión del formulario
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const contractNumber = contractNumberSelect.value;
            const isRetiro = checkRetiro.checked;
            const isIngreso = checkIngreso.checked;
            
            // 1. Validación de Contrato y Tipo de Novedad
            if (!contractNumber) {
                showFeedback('ERROR: Debe seleccionar el Número de Contrato antes de continuar.', 'error');
                return;
            }
            if (!isRetiro && !isIngreso) {
                showFeedback('ERROR: Debe seleccionar al menos una novedad (Retiro o Ingreso) para enviar el formulario.', 'error');
                return;
            }
            
            // 2. Validación de Campos Obligatorios (Ahora revisa *todos* los campos)
            if (isRetiro && !validateSection('retiro', 'Retiro')) {
                return;
            }
            if (isIngreso && !validateSection('ingreso', 'Ingreso')) {
                return;
            }

            // Iniciar proceso de envío
            submitButton.disabled = true;
            buttonText.textContent = 'Enviando...';
            submitButton.classList.add('opacity-70');
            showFeedback('Procesando envío, espere por favor...', 'info');

            // 3. Generación del contenido del Email
            let subject = `Novedad UDS - Contrato ${contractNumber} - `;
            let bodyContent = `Estimado(a) destinatario,\n\nSe presenta la siguiente novedad para el contrato UDS especificado a continuación:\n\n`;
            
            bodyContent += `--- DATOS GENERALES ---\nNúmero de Contrato: ${contractNumber}\n`;

            if (isRetiro) {
                bodyContent += getSectionData('retiro', 'BENEFICIARIO QUE SE RETIRA (SALE)');
                subject += "Retiro ";
            }
            
            if (isIngreso) {
                bodyContent += getSectionData('ingreso', 'BENEFICIARIO QUE INGRESA (ENTRA)');
                if(isRetiro) subject += "e Ingreso"; else subject += "Ingreso";
            }
            
            bodyContent += `\n\nPor favor, confirme la recepción y la aplicación de esta novedad.\n\nAtentamente.`;

            try {
                // 4. Envío a Formspree 
                const submissionData = {
                    _subject: subject.trim(),
                    _replyto: 'noreply@udsform.com',
                    'Cuerpo del Mensaje (Novedad UDS)': bodyContent,
                    _cc: RECIPIENT_EMAIL,
                    'Número de Contrato': contractNumber
                };

                const response = await fetch(FORMSPREE_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(submissionData)
                });

                // 5. Manejo de la respuesta
                if (response.ok) {
                    showFeedback('✅ ¡Novedad enviada con éxito! La novedad ha sido procesada por la API.', 'success');
                    // Limpiar el formulario y estilos
                    form.reset();
                    checkRetiro.checked = false;
                    checkIngreso.checked = false;
                    sectionRetiro.classList.add('hidden');
                    sectionIngreso.classList.add('hidden');
                    updateFormStyle(); // Volver al estilo inicial

                } else {
                    const errorData = await response.json();
                    let errorMessage = 'ERROR de API: No se pudo enviar el mensaje. Intente de nuevo o revise la consola.';
                    if (errorData.errors && errorData.errors.length > 0) {
                         errorMessage += ` Detalle: ${errorData.errors.map(err => err.message).join(', ')}`;
                    } else if (errorData.error) {
                         errorMessage = `ERROR: ${errorData.error}. Asegúrese de que el endpoint de Formspree sea correcto y esté verificado.`;
                    }
                    throw new Error(errorMessage);
                }

            } catch (error) {
                console.error('Error durante el envío de la API:', error);
                showFeedback(`❌ ${error.message}`, 'error');
            } finally {
                // Finalizar proceso
                submitButton.disabled = false;
                buttonText.textContent = 'Enviar Novedad por API';
                submitButton.classList.remove('opacity-70');
            }
        });
        
        // Inicializar el estilo al cargar la página (fondo negro-azul)
        document.addEventListener('DOMContentLoaded', updateFormStyle);
    </script>

</body>
</html>